(function(g){var window=this;'use strict';var gVX=function(k){const F=new g.Jl("und",new g.we("Default","und",!0));F.captionTracks=k.captionTracks;return F},T0I=function(k){return new g.hw(function(F,a){let V=k.length;
const M=[];if(V){var C=function(y,n){V--;M[y]=n;V==0&&F(M)},X=function(y){a(y)};
for(let y=0;y<k.length;y++){var U=k[y];g.ch(U,g.hV(C,y),X)}}else F(M)})},IT=function(k){return g.DI((0,g.CWV)(),k)},I7B=function({type:k,
payload:F}){k={type:k};F!==void 0&&(k.payload=F);return k},m$=function(k){k=k.key||k.id;
if(!k)throw Error("Entity key is missing");return k},mOz=function(){if(Sm)return Sm();
Sm=g.VB("PersistentEntityStoreDb",{Yx:{EntityStore:{ix:1},EntityAssociationStore:{ix:2}},shared:!1,upgrade(k,F){F(1)&&g.R5(g.tx(k,"EntityStore",{keyPath:"key"}),"entityType","entityType");F(2)&&(k=g.tx(k,"EntityAssociationStore",{keyPath:["parentEntityKey","childEntityKey"]}),g.R5(k,"byParentEntityKey","parentEntityKey"),g.R5(k,"byChildEntityKey","childEntityKey"))},version:3});return Sm()},SVC=function(k){return g.DI(mOz(),k)},Z2m=function(k){return k instanceof Error?new Zr("UNKNOWN_ENCODE_ERROR",
{originalMessage:k.message}):new Zr("UNKNOWN_ENCODE_ERROR")},enS=function(k){return k instanceof Error?new Zr("UNKNOWN_DECODE_ERROR",{originalMessage:k.message}):new Zr("UNKNOWN_DECODE_ERROR")},dO7=function(k,F){k=k instanceof Zr?k:F(k);
g.W(k);throw k;},PH7=function(k,F,a){try{return k.O(F,a)}catch(V){dO7(V,Z2m)}},em=function(k){k=(new TextEncoder).encode(k).subarray(0,16);
const F=new Uint8Array(16);F.set(k);return F},JLm=function(k){const F=H2k[k];
if(F)return F;g.HS(new g.o5("Entity model not found.",{entityType:k}))},Pf=function(k,F){a:{k=dj(k.K,F.version);
try{var a=k.K(F.data,F.key);break a}catch(V){dO7(V,enS)}a=void 0}return a},Hf=function(k,F,a){return k.D.objectStore("EntityStore").get(F).then(V=>{if(V){if(a&&V.entityType!==a)throw Error("Incorrect entity type");
return Pf(k,V)}})},JN=function(k,F,a){return a?(a=a.map(V=>Hf(k,V,F)),g.Bj.all(a)):k.D.objectStore("EntityStore").index("entityType").getAll(IDBKeyRange.only(F)).then(V=>V.map(M=>Pf(k,M)))},rLm=function(k,F,a){const V=m$(F);
return Qo(k,V).then(()=>QsQ(k,F,a))},rj=function(k,F,a){let V=k.O[a];
V||(V=new Set,k.O[a]=V);V.add(F)},hN=function(k,F,a){const V=m$(F),M=dj(k.K,1),C={...F};
return k.D.objectStore("EntityStore").get(V).then(X=>{if(X){if(X.entityType!==a)throw Error("Incorrect entity type");C.entityMetadata||(X=Pf(k,X),C.entityMetadata=X.entityMetadata)}}).then(()=>{const X={key:V,
entityType:a,data:PH7(M,C,V),version:1};return g.Bj.all([k.D.objectStore("EntityStore").put(X),rLm(k,C,a)])}).then(()=>{rj(k,V,a);
return V})},xN=function(k,F,a){F=F.map(V=>hN(k,V,a));
return g.Bj.all(F)},xOS=function(k,F,a){if(a.has(F))return g.Bj.resolve(void 0);
a.add(F);return hnI(k,F).then(V=>k.D.objectStore("EntityAssociationStore").index("byParentEntityKey").delete(IDBKeyRange.only(F)).then(()=>V)).then(V=>{let M=g.Bj.resolve(void 0);
for(const C of V)M=M.then(()=>xOS(k,C,a));
return M}).then(()=>{})},AN=function(k,F,a){if(a?.Cq){const M=new Set;
return xOS(k,F,M).then(()=>{const C=[];for(const X of M)C.push(AN(k,X));return g.Bj.all(C).then(()=>{})})}const V=g.Zk(F).entityType;
return g.Bj.all([k.D.objectStore("EntityStore").delete(F),Qo(k,F)]).then(()=>{rj(k,F,V)})},Qo=function(k,F){return k.D.objectStore("EntityAssociationStore").index("byParentEntityKey").delete(IDBKeyRange.only(F))},Bf=function(k,F){return g.EC(k.D.objectStore("EntityStore").index("entityType"),{query:IDBKeyRange.only(F)},a=>g.Bj.all([a.delete(),
Qo(k,a.cursor.primaryKey)]).then(()=>{rj(k,a.cursor.primaryKey,F);return g.$7(a)}))},ALm=function(k,F,a,V){const M=dj(k.K,1);
return Hf(k,F,V).then(C=>{if(C){C=g.wl(C,a);var X={key:F,entityType:V,data:PH7(M,C,F),version:1};return g.Bj.all([k.D.objectStore("EntityStore").put(X),rLm(k,C,V)])}}).then(()=>{rj(k,F,V);
return F})},QsQ=function(k,F,a){const V=m$(F);
a=JLm(a);if(!a)return g.Bj.resolve([]);F=new a(F);k=k.D.objectStore("EntityAssociationStore");a=[];for(const M of F.K())a.push(k.put({parentEntityKey:V,childEntityKey:M}));return g.Bj.all(a).then(M=>M.map(C=>C[1]))},hnI=function(k,F){const a=k.D.objectStore("EntityAssociationStore");
return a.index("byParentEntityKey").getAll(IDBKeyRange.only(F)).then(V=>{const M=[];for(const C of V)M.push(a.index("byChildEntityKey").getAll(C.childEntityKey));return g.Bj.all(M)}).then(V=>{const M=[];
for(const C of V)C.length===1&&M.push(C[0].childEntityKey);return M})},dj=function(k,F=0){k=k.D[F];
if(!k)throw F=new Zr("INVALID_ENCODER_VERSION",{Yj:F}),g.W(F),F;return k},B07=function(k,F){for(const a of k.observers)a(F)},YN=async function(k,F,a){var V=await SVC(k.token);
let M;F=await g.pZ(V,["EntityStore","EntityAssociationStore"],F,C=>{M=new YVQ(C,k.D);return a(M)});
M&&(V=M.O,Object.keys(V).length>0&&(k.channel.postMessage(V),B07(k,V)));return F},Ob=function(k,F,a){return YN(k,{mode:"readwrite",
PB:!0},V=>hN(V,F,a))},O2z=function(k,F){return YN(k,{mode:"readwrite",
PB:!0},a=>xN(a,F,"offlineOrchestrationActionWrapperEntity"))},lO=function(k,F){return YN(k,{mode:"readwrite",
PB:!0},a=>AN(a,F))},l7k=function(k){return YN(k,{mode:"readwrite",
PB:!0},F=>Bf(F,"videoPlaybackPositionEntity"))},vf=function(k,F,a){return YN(k,{mode:"readonly",
PB:!0},V=>Hf(V,F,a))},cf=function(k,F,a){return YN(k,{mode:"readonly",
PB:!0},V=>JN(V,F,a))},prI=async function(){try{const F=await g.FU();
if(F&&g.y1()&&typeof g.Tm.BroadcastChannel!=="undefined"){var k=new vVB;return new cLL(F,k)}}catch(F){F instanceof Error&&g.W(F)}},tN=function(){pf||(pf=prI());
return pf},t9X=function(k){k=k.options?.persistenceOption;
return k==="ENTITY_PERSISTENCE_OPTION_PERSIST"||k==="ENTITY_PERSISTENCE_OPTION_INMEMORY_AND_PERSIST"},LOI=async function(k){const F=await tN();
F&&await YN(F,"readwrite",a=>{const V={};for(const M of k){if(!M.entityKey||!t9X(M))continue;const C=g.pz(M.payload);let X=void 0;M.type==="ENTITY_MUTATION_TYPE_REPLACE"&&(X=()=>hN(a,M.payload[C],C));
M.type==="ENTITY_MUTATION_TYPE_DELETE"&&(X=()=>AN(a,M.entityKey));
M.type==="ENTITY_MUTATION_TYPE_UPDATE"&&(X=()=>ALm(a,M.entityKey,M.payload[C],C));
X&&(V[M.entityKey]=V[M.entityKey]?V[M.entityKey].then(X):X())}return g.Bj.all(Object.values(V))})},Lf=async function(k){!(k=k.mutations)||k.length<=0||(g.yA&&g.yA.dispatch(I7B({type:"ENTITY_LOADED",
payload:k})),await LOI(k),k.length=0)},RnS=function(k){return k!==void 0},jsZ=function(k){var F=g.Wb();
F=Object.assign({},F);k=Object.assign({},k);for(const a in F)k[a]?(F[a]!==4&&(F[a]=k[a]),delete k[a]):F[a]!==2&&(F[a]=4);Object.assign(F,k);g.ory(F);JSON.stringify(F);return F},WOz=async function(k){const F=await g.FU();
return F?g.pZ(await g.NH(F),["index","media","captions"],{mode:"readwrite",PB:!0},a=>{const V=IDBKeyRange.bound(k+"|",k+"~");a=[a.objectStore("index").delete(V),a.objectStore("media").delete(V),a.objectStore("captions").delete(V)];return g.Bj.all(a).then(()=>{})}):void 0},$OZ=async function(){const k=await g.FU();
if(!k)throw g.Ax("rvdfd");return g.pZ(await g.NH(k),["index","media"],{mode:"readwrite",PB:!0},F=>{const a={};return g.Wj(F.objectStore("index"),{},V=>{var M=V.cursor.key.match(/^([\w\-_]+)\|(a|v)$/);let C=g.Bj.resolve(void 0);if(M){const X=M[1];M=M[2];a[X]=a[X]||{};a[X][M]=g.qZQ(V.getValue()?.fmts)}else C=V.delete().then(()=>{});
return g.Bj.all([g.$7(V),C]).then(([X])=>X)}).then(()=>{const V={};
for(const C of Object.keys(a)){const X=a[C].v;V[C]=a[C].a&&X?1:2}const M=jsZ(V);return g.OKQ(F.objectStore("media"),{},C=>{const X=C.cursor.key.match(g.m41);X&&V[X[1]]||F.objectStore("media").delete(C.cursor.key);return g.J9m(C)}).then(()=>M)})})},EV8=async function(k,F){var a=await g.FU();
if(!a)throw g.Ax("wct");a=await g.NH(a);await g.pZ(a,["captions"],{mode:"readwrite",PB:!0},V=>{const M=[];V=V.objectStore("captions");for(let C=0;C<F.length;C++){const X=V.put(F[C],k+"|"+F[C].metadata.vss_id);M.push(X)}return g.Bj.all(M)})},N0Q=async function(k){k=IDBKeyRange.bound(k+"|",k+"~");
const F=await g.FU();if(!F)throw g.Ax("gactfv");return(await g.NH(F)).getAll("captions",k)},DOL=async function(k){g.ER(k,0);
return WOz(k)},i2X=function(k){return{context:g.Fq(),
videoIds:k}},f7R=function(k){return{context:g.Fq(),
playlistIds:k}},znz=function(k){return{context:g.Fq(),
offlinePlaylistSyncChecks:k}},b2S=function(){RT||(RT=new GkL);
return RT},wrQ=function(k,F){return{eventType:{flowEventNamespace:"FLOW_EVENT_NAMESPACE_OFFLINE_ORCHESTRATION",
flowEventType:k},metadata:F,statusCode:void 0,csn:void 0,can:void 0}},kHk=function(k,F,a){a||(a=k.D.get("FLOW_TYPE_OFFLINE_ORCHESTRATION"),a||(a=g.yv(16),k.D.set("FLOW_TYPE_OFFLINE_ORCHESTRATION",a)));
k={flowNonce:a,flowType:"FLOW_TYPE_OFFLINE_ORCHESTRATION",flowEventType:F.eventType};F.metadata&&(k.flowMetadata=F.metadata);F.statusCode!==void 0&&(k.flowEventStatus=F.statusCode);F.csn&&(k.csn=F.csn);F.can&&(k.can=F.can);g.yJ("flowEvent",k,void 0)},Fi7=async function(k){var F=await YN(k,{mode:"readonly",
PB:!0},T=>JN(T,"playbackData").then(S=>{var J=S.map(l=>l.transfer).filter(l=>!!l),x=S.map(l=>l.offlineVideoPolicy).filter(l=>!!l),O=S.filter(l=>!!l.key).map(l=>g.eG(g.Zk(l.key).entityId,"downloadStatusEntity"));
J=JN(T,"transfer",J);x=JN(T,"offlineVideoPolicy",x);O=JN(T,"downloadStatusEntity",O);const A=J.then(l=>{l=l.reduce((t,M7)=>{M7?.offlineVideoStreams&&t.push(...M7.offlineVideoStreams);return t},[]).filter(t=>!!t);
return JN(T,"offlineVideoStreams",l)});
return g.Bj.all([J,x,A,O]).then(([l,t,M7,X9])=>[S,l,t,M7,X9])}));
k=await YN(k,{mode:"readonly",PB:!0},T=>JN(T,"mainDownloadsListEntity").then(S=>S[0]?.downloads??[]));
const [a,V,M,C,X]=F,U={},y={},n={},u={},K={};F=[];for(var q of V)q&&(U[q.key]=q);for(const T of M)T&&(y[T.key]=T);for(const T of X)T&&(n[T.key]=T);for(const T of C)T&&(u[T.key]=T);for(const T of k)K[T.videoItem??""]=!0,T.videoItem&&(q=g.Zk(T.videoItem)?.entityId??"",F.push({externalVideoId:q}));return{offlineVideos:a.filter(T=>{if(!T||!T.key||!T.offlineVideoPolicy)return!1;T=g.Zk(T.key).entityId;T=g.eG(T,"downloadStatusEntity");return!(T&&n[T]?.downloadState==="DOWNLOAD_STATE_USER_DELETED")}).map(T=>
{var S=U[T.transfer];
const J=[];if(S?.offlineVideoStreams)for(var x of S.offlineVideoStreams){var O=u[x];O&&J.push(O)}x=y[T.offlineVideoPolicy];O=T?.playerResponseTimestamp;var A=g.Zk(x.key).entityId;T=g.eG(A,"mainVideoEntity");if(x.action==="OFFLINE_VIDEO_POLICY_ACTION_DISABLE"){var l="OFFLINE_VIDEO_STATE_DISABLED";x.expirationTimestamp&&Number(x.expirationTimestamp)<Date.now()/1E3&&(l="OFFLINE_VIDEO_STATE_EXPIRED")}else if(x.action==="OFFLINE_VIDEO_POLICY_ACTION_DOWNLOAD_FAILED")l="OFFLINE_VIDEO_STATE_OFFLINE_FAILED";
else{switch(S?.transferState){case "TRANSFER_STATE_TRANSFER_IN_QUEUE":l="OFFLINE_VIDEO_STATE_PENDING";break;case "TRANSFER_STATE_TRANSFERRING":l="OFFLINE_VIDEO_STATE_TRANSFERRING";break;case "TRANSFER_STATE_PAUSED_BY_USER":l="OFFLINE_VIDEO_STATE_PAUSED_TRANSFER";break;case "TRANSFER_STATE_FAILED":l="OFFLINE_VIDEO_STATE_OFFLINE_FAILED";break;case "TRANSFER_STATE_COMPLETE":l="OFFLINE_VIDEO_STATE_PLAYABLE";break;case "TRANSFER_STATE_WAITING_FOR_PLAYER_RESPONSE_REFRESH":l="OFFLINE_VIDEO_STATE_STREAMS_OUT_OF_DATE";
break;default:l="OFFLINE_VIDEO_STATE_UNKNOWN"}if(l==="OFFLINE_VIDEO_STATE_OFFLINE_FAILED")switch(S?.failureReason){case "TRANSFER_FAILURE_REASON_EXTERNAL_FILESYSTEM_WRITE":case "TRANSFER_FAILURE_REASON_FILESYSTEM_WRITE":l="OFFLINE_VIDEO_STATE_OUT_OF_STORAGE_ERROR";break;case "TRANSFER_FAILURE_REASON_STREAM_MISSING":l="OFFLINE_VIDEO_STATE_STREAMS_MISSING";break;case "TRANSFER_FAILURE_REASON_NETWORK":case "TRANSFER_FAILURE_REASON_NETWORK_LOST":l="OFFLINE_VIDEO_STATE_NETWORK_ERROR"}}A={id:A,videoState:l};
S?.cotn&&(A.cotn=S.cotn);S?.maximumDownloadQuality&&(A.selectedVideoQuality=S?.maximumDownloadQuality);S?.lastProgressTimeMs&&(A.lastProgressTimeMs=S.lastProgressTimeMs);O&&(A.playerResponseSavedTimeMs=String(Number(O)*1E3));S=String;O=0;for(const t of J)if(t.streamsProgress)for(const M7 of t.streamsProgress)O+=Number(M7.numBytesDownloaded??0);A.downloadedBytes=S(O);A.selectedOfflineMode=K[T]?"OFFLINE_MODE_TYPE_AUTO_OFFLINE":"OFFLINE_NOW";x.action==="OFFLINE_VIDEO_POLICY_ACTION_DISABLE"&&(A.offlinePlaybackDisabledReason=
x.offlinePlaybackDisabledReason);return A}),
additionalOfflineClientState:{mainAppAdditionalOfflineClientState:{smartDownloadVideos:F}}}},VbX=function(){try{let a=g.mw("ytglobal.locks_");
if(a)return a;var k;if(k=navigator){var F=navigator;k="locks"in F&&!!F.locks}if(k)return g.Tm.localStorage&&g.Tm.localStorage.getItem("noop"),a=new aLQ,g.IH("ytglobal.locks_",a),a}catch{}},jm=function(k){if(k.includes(":"))throw Error(`Invalid user cache name: ${k}`);
return`${k}:${g.UC("CacheStorage get")}`},MbI=async function(){return Wf!==void 0?Wf:Wf=new Promise(async k=>{try{await $N.open("test-only"),await $N.delete("test-only")}catch(F){if(F instanceof Error&&F.name==="SecurityError"){k(!1);
return}}k("caches"in window)})},NN=async function(){if(await MbI())return Eb||(Eb=new CeI),Eb},Dr=function(k,F,a){g.HS(new g.o5(`Woffle: ${k}`,a?{cotn:a}:""));
F instanceof Error&&g.HS(F)},so8=async function(k){k=await Fi7(k);
g.yJ("offlineStateSnapshot",k)},iO=function(k,F){g.zD(k.api,"onOfflineOperationFailure",F);
k.D?.postMessage(F)},Xk8=function(k){if(!k.O&&!k.D){var F=VbX();
if(F){k.O=!0;var a=g.UC("OfflineLockManager");F.request(`${"woffle_orchestration_leader"}:${a}`,{},async()=>{try{k.K=new g.aE,k.D=!0,k.O=!1,await k.W(),await k.K.promise}catch(V){k.yB(),V instanceof Error&&(V.args=[{name:"WoLockManagerError",UJ:V.name}],g.W(V))}})}}},ff=function(k){k.T&&k.C&&k.Z&&k.visibility.isBackground()?k.V.Wl(6E4):k.V.stop()},UnX=function(k){k.D&&(k.Z=!0,ff(k))},y9z=function(k,F){k.D&&(k.C=F,ff(k))},o0S=function(k,F){k.D&&(k.T=F,ff(k))},z9=function(k){k.offlineDeleteReason=k.offlineDeleteReason??
"OFFLINE_DELETE_REASON_UNKNOWN";
k.offlineModeType=k.offlineModeType??"OFFLINE_NOW";g.yJ("offlineDeleteEvent",k)},G9=function(k,{videoId:F,
sM:a,offlineModeType:V}){k.encryptedVideoId=F;k.cotn=a?.cotn;k.offlineabilityFormatType=a?.maximumDownloadQuality;k.isRefresh=a?.isRefresh??!1;k.softErrorCount=a?.transferRetryCount??0;k.offlineModeType=V??"OFFLINE_NOW";(k.transferStatusType==="TRANSFER_STATUS_TYPE_UNKNOWN"&&k.statusType==="UNKNOWN_STATUS_TYPE"||!k.transferStatusType&&!k.statusType)&&g.HS(Error("Woffle unknown transfer status"));g.yJ("offlineTransferStatusChanged",k)},n0R=function(k,F,a,V){V={transferStatusType:"TRANSFER_STATUS_TYPE_PROCESSING",
statusType:"OFFLINING_STARTED",transferFirstStarted:!!V};F&&a&&(F=Math.floor(F/1024).toFixed(),a=Math.floor(a/1024).toFixed(),V.alreadyDownloadedKbytes=F,V.totalFetchedKbytes=F,V.totalContentKbytes=a);G9(V,k)},uMZ=function(k){G9({transferStatusType:"TRANSFER_STATUS_TYPE_DEQUEUED_BY_USER_PAUSE",
statusType:"SUSPENDED"},k)},Ki7=function(k){switch(k){case "TRANSFER_FAILURE_REASON_FILESYSTEM_WRITE":case "TRANSFER_FAILURE_REASON_EXTERNAL_FILESYSTEM_WRITE":return"OFFLINE_DATABASE_ERROR";
case "TRANSFER_FAILURE_REASON_PLAYABILITY":return"NOT_PLAYABLE";case "TRANSFER_FAILURE_REASON_TOO_MANY_RETRIES":return"TOO_MANY_RETRIES";case "TRANSFER_FAILURE_REASON_INTERNAL":return"OFFLINE_DOWNLOAD_CONTROLLER_ERROR";case "TRANSFER_FAILURE_REASON_STREAM_MISSING":return"STREAM_VERIFICATION_FAILED";case "TRANSFER_FAILURE_REASON_SERVER":case "TRANSFER_FAILURE_REASON_SERVER_PROPERTY_MISSING":return"OFFLINE_REQUEST_FAILURE";case "TRANSFER_FAILURE_REASON_NETWORK":return"OFFLINE_NETWORK_ERROR";default:return"UNKNOWN_FAILURE_REASON"}},
bO=function(k){return(k.actionMetadata?.retryScheduleIntervalsInSeconds?.length??0)>0},wj=function(k){return k.actionType==="OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD"&&!!k.entityKey},kW=function(k){return k.actionType==="OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH"&&!!k.entityKey},FC=function(k){return k.actionType==="OFFLINE_ORCHESTRATION_ACTION_TYPE_DELETE"&&!!k.entityKey},qPL=function(k){return k.actionType==="OFFLINE_ORCHESTRATION_ACTION_TYPE_UPDATE"&&!!k.entityKey},ag=async function(k,F,a,V,M=!1){const C=
g.eG(k,F),X=g.eG(k,"downloadStatusEntity");
k=await YN(a,{mode:"readonly",PB:!0},y=>g.Bj.all([Hf(y,C,F),Hf(y,X,"downloadStatusEntity")]));
const U=k.length?k[0]:void 0;if(U){let y=k.length>1?k[1]:void 0;if(y){if(y.downloadState==="DOWNLOAD_STATE_USER_DELETED"&&!M)return;y.downloadState=V}else y={key:X,downloadState:V};g.YX(U,g0X,y);await YN(a,{mode:"readwrite",PB:!0},n=>g.Bj.all([hN(n,U,F),hN(n,y,"downloadStatusEntity")]))}},VE=function(k,F){return k.actionType===F.actionType&&k.entityKey===F.entityKey},MT=function(k,F){if(k&&k.transferState!=="TRANSFER_STATE_COMPLETE"&&k.transferState!=="TRANSFER_STATE_FAILED"){const a=g.Zk(k.key).entityId;
G9({transferStatusType:"TRANSFER_STATUS_TYPE_TERMINATED_BY_USER",statusType:"CANCELLED"},{videoId:a,sM:k,offlineModeType:F})}},Cp=function(k){if(!k||!k.thumbnails)return[];
const F=[];for(const a of k.thumbnails)a.url&&F.push(a.url);return F},sa=async function(k,F,a=[]){if(!a.length)return[];
F=await cf(k,F);k=new Set;for(var V of F)if(F=V.id||V.key)F=g.Zk(F).entityId,k.add(F);V=[];for(const M of a)a=M.offlineVideoData,a?.videoId&&!k.has(a.videoId)&&V.push(M);return V},XC=function(k,F,a){return new g.mS(k,{cotn:F,
raw_player_response:a,download_media:!0,start:Infinity,disable_watch_next:!0})},Ua=function(){return{priority:1,
retryScheduleIntervalsInSeconds:[1,2,4]}},og=function(k){if(!k.key)throw Error("Entity key is required.");
if(!k.actionProto)throw Error("OfflineOrchestrationAction is required.");const F=g.Zk(k.key),a=g.Zk(k.actionProto.entityKey);return new yE(a.entityType,F.entityId,k.actionProto,k.parentActionId,k.rootActionId,k.childActionIds,k.prereqActionId,k.postreqActionIds,k.retryScheduleIndex,k.hasChildActionFailed,Number(k.enqueueTimeSec)*1E3)},np=function(k){return{key:g.eG(k.actionId,"offlineOrchestrationActionWrapperEntity"),
actionProto:k.action,parentActionId:k.parentActionId,rootActionId:k.rootActionId,childActionIds:k.childActionIds,prereqActionId:k.prereqActionId,postreqActionIds:k.postreqActionIds,retryScheduleIndex:k.retryScheduleIndex,hasChildActionFailed:k.hasChildActionFailed,enqueueTimeSec:(k.D/1E3).toFixed()}},TAC=async function(){const k=await NN();
return k?k.delete("yt-player-local-img"):!0},uW=async function(k){const F=await NN();
if(!F)throw Error("Cache API not supported");if(k.length){var a=await F.open("yt-player-local-img");await Promise.all(k.map(V=>a.delete(V)))}},Kp=async function(k){const F=await NN();
if(!F)throw Error("Cache API not supported");k.length&&await (await F.open("yt-player-local-img")).addAll(k)},qT=async function(k,F,a,V,M){const C=g.eG(k,"mainVideoEntity"),X=g.eG(k,"ytMainChannelEntity"),U=g.eG(k,"transfer"),y=g.eG(k,"videoDownloadContextEntity");
var n=await YN(F,{mode:"readonly",PB:!0},l=>g.Bj.all([Hf(l,C,"mainVideoEntity"),Hf(l,X,"ytMainChannelEntity"),Hf(l,U,"transfer"),Hf(l,y,"videoDownloadContextEntity"),JN(l,"ytMainChannelEntity"),JN(l,"offlineOrchestrationActionWrapperEntity")]));
const [u,K,q,T,S,J]=n;if(u||K){n=u?Cp(u.thumbnail):[];var x=K?await ILL(K,S):[];await uW(n.concat(x))}const O=[],A=g.eG(k,"downloadStatusEntity");for(const l of J)n=g.Zk(l.key).entityId,x=og(l),x=g.Zk(x.action.entityKey).entityId,n!==k&&x!==k||VE(a,l.actionProto)||O.push(l.key);await YN(F,{mode:"readwrite",PB:!0},l=>{const t=O.map(M7=>AN(l,M7));
t.push(AN(l,C,{Cq:!0}));t.push(AN(l,A,{Cq:!0}));return g.Bj.all(t)});
k=T?.offlineModeType;M&&(z9(M),M.offlineModeType&&(k=M.offlineModeType));MT(q,k);iO(V,{entityKey:C,failureReason:"OFFLINE_OPERATION_FAILURE_REASON_VIDEO_DELETED"})},gB=async function(k,F,a,V){const M=g.eG(k,"mainPlaylistEntity"),C=g.eG(k,"ytMainChannelEntity");
var X=await YN(F,{mode:"readonly",PB:!0},l=>g.Bj.all([Hf(l,M,"mainPlaylistEntity"),Hf(l,C,"ytMainChannelEntity"),JN(l,"mainPlaylistEntity"),JN(l,"mainDownloadsListEntity"),JN(l,"ytMainChannelEntity"),JN(l,"offlineOrchestrationActionWrapperEntity")]));
const [U,y,n,u,K,q]=X;if(U||y){X=U?mnX(U):[];var T=y?await ILL(y,K):[];await uW(X.concat(T))}X=[];T=new Map;if(U){X=await SPz(U,n,u);for(var S of X)T.set(S,{videoId:S,playlistId:k,offlineDeleteReason:"OFFLINE_DELETE_REASON_PARENT_LIST_DELETE"});S=await YN(F,{mode:"readonly",PB:!0},M7=>g.Bj.all([JN(M7,"transfer"),JN(M7,"videoDownloadContextEntity")]));
const [l,t]=S;for(var J of l)S=g.Zk(J.key).entityId,(S=T.get(S))&&J&&(S.cotn=J.cotn);for(var x of t)J=g.Zk(x.key).entityId,(J=T.get(J))&&x&&(J.offlineModeType=x.offlineModeType)}const O=[];for(const l of q)x=g.Zk(l.key).entityId,J=og(l),x!==k&&J.rootActionId!==k||VE(a,l.actionProto)||O.push(l.key);const A=g.eG(k,"mainPlaylistEntity");await YN(F,{mode:"readwrite",PB:!0},l=>{const t=O.map(M7=>AN(l,M7));
t.push(AN(l,A,{Cq:!0}));return g.Bj.all(t)});
if(U&&(X.reverse(),X))for(const l of X)await qT(l,F,a,V,T.get(l))},Tb=async function(k,F,a,V){const M=g.eG("DOWNLOADS_LIST_ENTITY_ID_MANUAL_DOWNLOADS","mainDownloadsListEntity"),C=new Map;
k=await YN(k,{mode:"readwrite",PB:!0},X=>{const U=JN(X,"transfer"),y=JN(X,"offlineOrchestrationActionWrapperEntity"),n=JN(X,"videoDownloadContextEntity"),u=Hf(X,M,"mainDownloadsListEntity");return g.Bj.all([U,y,n,u]).then(([K,q,T,S])=>{const J=ZKZ.map(x=>Bf(X,x));
for(const x of q)VE(F,x.actionProto)||J.push(AN(X,x.key,{Cq:!0}));S&&(S.downloads=[],J.push(hN(X,S,"mainDownloadsListEntity")));if(T)for(const x of T)q=g.Zk(x.key).entityId,q=g.eG(q,"transfer"),C.set(q,x.offlineModeType);return g.Bj.all(J).then(()=>K)})});
for(const X of k){MT(X,C.get(X.key));k=g.Zk(X.key).entityId;const U={videoId:k,offlineDeleteReason:V,cotn:X.cotn,offlineModeType:C.get(X.key)};z9(U);k=g.eG(k,"mainVideoEntity");iO(a,{entityKey:k,failureReason:"OFFLINE_OPERATION_FAILURE_REASON_VIDEO_DELETED"})}await TAC()},mnX=function(k,F){let a=[];
if(k.thumbnailStyleData)for(const V of k.thumbnailStyleData)a=a.concat(Cp(V?.value?.collageThumbnail?.coverThumbnail));k=Cp(F);return a.concat(k)},SPz=async function(k,F,a){const V=[],M=new Set;
if(a.length)for(var C of a)if(C.downloads?.length)for(const X of C.downloads)X.videoItem&&(a=g.Zk(X.videoItem).entityId,M.add(a));if(k.videos){for(const X of k.videos)C=JSON.parse(g.Zk(X).entityId),C.videoId&&!M.has(C.videoId)&&V.push(C.videoId);for(const X of F)if(X.key!==k.key&&(F=X.videos))for(const U of F)F=JSON.parse(g.Zk(U).entityId),F.videoId&&(F=V.indexOf(F.videoId),F!==-1&&V.splice(F,1))}return V},ILL=async function(k,F){const a=Cp(k.avatar);
for(const V of F)if(V.id!==k.id)for(const M of Cp(V.avatar))F=a.indexOf(M),F!==-1&&a.splice(F,1);return a},eiz=async function(k){const F=g.p(k.frameworkUpdates,Ig);
k.frameworkUpdates&&F&&await Lf(F)},HKS=function(k){if(k.onResponseReceivedActions?.length&&(k=g.p(g.p(k.onResponseReceivedActions[0],dnQ),Pez)?.actions,k?.length))return k},J98=async function(k){if(!k)return[];
k=await vf(k,m9,"mainDownloadsListEntity");return k?.downloads?.length?k.downloads.map(F=>F.videoItem??""):[]},Sq=async function(k,F){const a=await Qoz(k,F);
a&&await YN(k,{mode:"readwrite",PB:!0},V=>{const M=[hN(V,a.mainDownloadsLibraryEntity,"mainDownloadsLibraryEntity")];a.mainDownloadsListEntity&&M.push(hN(V,a.mainDownloadsListEntity,"mainDownloadsListEntity"));return g.Bj.all(M)})},Qoz=async function(k,F){const a=g.eG("main_downloads_library_id","mainDownloadsLibraryEntity"),V=g.eG("DOWNLOADS_LIST_ENTITY_ID_MANUAL_DOWNLOADS","mainDownloadsListEntity");
k=await YN(k,{mode:"readonly",PB:!0},y=>g.Bj.all([Hf(y,a,"mainDownloadsLibraryEntity"),Hf(y,V,"mainDownloadsListEntity")]));
let [M,C]=k;k=M;let X=C;k||(k={id:a});for(const y of F)if(y===m9){if(k.smartDownloadsList)return;k.smartDownloadsList=y}else{var U=g.Zk(y).entityType;F={};U==="mainPlaylistEntity"?F.playlistItem=y:U==="mainVideoEntity"&&(F.videoItem=y);if(!g.NL(F)){if(X?.downloads){U=!1;for(const n of X.downloads)if(n.playlistItem===y||n.videoItem===y){U=!0;break}U||X.downloads.push(F)}else X={id:V,downloads:[F]};k.downloadsList=V}}return{mainDownloadsLibraryEntity:k,mainDownloadsListEntity:X}},ZF=async function(k,
F){const a=g.eG("main_downloads_library_id","mainDownloadsLibraryEntity"),V=g.eG("DOWNLOADS_LIST_ENTITY_ID_MANUAL_DOWNLOADS","mainDownloadsListEntity");
var M=await YN(k,{mode:"readonly",PB:!0},y=>g.Bj.all([Hf(y,a,"mainDownloadsLibraryEntity"),Hf(y,V,"mainDownloadsListEntity"),Hf(y,m9,"mainDownloadsListEntity")]));
const [C,X,U]=M;if(C){if(F===m9&&U?.downloads)U.downloads=[];else if(X?.downloads){M=g.Zk(F).entityType;for(let y=0;y<X.downloads.length;y++){const n=X.downloads[y];if(M==="mainVideoEntity"&&n.videoItem===F){X.downloads.splice(y,1);break}else if(M==="mainPlaylistEntity"&&n.playlistItem===F){X.downloads.splice(y,1);break}}}await YN(k,{mode:"readwrite",PB:!0},y=>{const n=[hN(y,C,"mainDownloadsLibraryEntity")];X&&n.push(hN(y,X,"mainDownloadsListEntity"));U&&n.push(hN(y,U,"mainDownloadsListEntity"));
return g.Bj.all(n)})}},eq=async function(k,F){const a=g.eG(F,"transfer"),V=g.eG(F,"videoDownloadContextEntity");
k=await YN(k,{mode:"readonly",PB:!0},X=>g.Bj.all([Hf(X,a,"transfer"),Hf(X,V,"videoDownloadContextEntity")]));
const [M,C]=k;return{videoId:F,cotn:M?.cotn,offlineModeType:C?.offlineModeType}},dB=async function(k,F,a,V,M){const C=g.eG(k,"musicTrack"),X=g.eG(k,"transfer");
var U=await YN(F,{mode:"readonly",PB:!0},S=>g.Bj.all([Hf(S,C,"musicTrack"),Hf(S,X,"transfer"),JN(S,"musicTrack"),JN(S,"offlineOrchestrationActionWrapperEntity")]));
const [y,n,u,K]=U;y&&(U=await r9Q(y,u),await uW(U));const q=[];for(const S of K){U=g.Zk(S.key).entityId;var T=og(S);T=g.Zk(T.action.entityKey).entityId;U!==k&&T!==k||VE(a,S.actionProto)||q.push(S.key)}await YN(F,{mode:"readwrite",PB:!0},S=>{const J=q.map(x=>AN(S,x));
J.push(AN(S,C,{Cq:!0}));return g.Bj.all(J)});
MT(n);M&&z9(M);iO(V,{entityKey:C,failureReason:"OFFLINE_OPERATION_FAILURE_REASON_VIDEO_DELETED"})},PK=async function(k,F,a,V,M){const C=g.eG(k,F),X=g.eG("music_downloads_library_id","musicDownloadsLibraryEntity");
var U=await YN(a,{mode:"readonly",PB:!0},O=>g.Bj.all([Hf(O,C,F),Hf(O,X,"musicDownloadsLibraryEntity"),JN(O,F),JN(O,"offlineOrchestrationActionWrapperEntity")]));
const [y,n,u,K]=U;y&&(U=await r9Q(y,u),await uW(U));let q=[];U=new Map;if(y){q=await hik(y,u,n);for(var T of q){const O=g.Zk(T).entityId;U.set(O,{videoId:O,playlistId:k,offlineDeleteReason:"OFFLINE_DELETE_REASON_PARENT_LIST_DELETE"})}T=await cf(a,"transfer");for(var S of T)T=g.Zk(S.key).entityId,(T=U.get(T))&&S&&(T.cotn=S.cotn)}const J=[];for(const O of K)S=g.Zk(O.key).entityId,T=og(O),S!==k&&T.rootActionId!==k||VE(V,O.actionProto)||J.push(O.key);const x=g.eG(k,F);await YN(a,{mode:"readwrite",PB:!0},
O=>{const A=J.map(l=>AN(O,l));
A.push(AN(O,x,{Cq:!0}));return g.Bj.all(A)});
if(y&&(q.reverse(),q.length))for(const O of q)(k=g.Zk(O).entityId)&&await dB(k,a,V,M,U.get(k))},HK=async function(k,F,a){k=await YN(k,{mode:"readwrite",
PB:!0},V=>{const M=JN(V,"transfer"),C=JN(V,"offlineOrchestrationActionWrapperEntity");return g.Bj.all([M,C]).then(([X,U])=>{const y=xn7.map(n=>Bf(V,n));
for(const n of U){U=g.Zk(n.actionProto.entityKey).entityType==="musicTrack";const u=n.actionProto.actionType==="OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD";VE(F,n.actionProto)||U&&(!U||u)||y.push(AN(V,n.key,{Cq:!0}))}return g.Bj.all(y).then(()=>X)})});
for(const V of k)MT(V),k=g.Zk(V.key).entityId,z9({videoId:k,offlineDeleteReason:void 0,cotn:V.cotn}),k=g.eG(k,"musicTrack"),iO(a,{entityKey:k,failureReason:"OFFLINE_OPERATION_FAILURE_REASON_VIDEO_DELETED"});await TAC()},A9Q=function(k){let F;
for(const a of k.additionalMetadatas)a.offlineMusicVideoData&&(F=a.offlineMusicVideoData);return{id:g.eG(k.videoId,"musicTrack"),videoId:k.videoId,title:k.title,thumbnailDetails:k.thumbnail,lengthMs:String(Number(k.lengthSeconds)*1E3),albumTitle:F?.releaseTitle,musicVideoType:F?.musicVideoType,contentRating:{explicitType:F?.explicitType},artistNames:F?.byline||F?.channelName,downloadMetadata:g.eG(k.videoId,"musicTrackDownloadMetadataEntity")}},hik=async function(k,F,a){const V=[],M=new Set;
if(a?.downloadedTracks?.length)for(const C of a.downloadedTracks)M.add(C);if(k.tracks){for(const C of k.tracks)M.has(C)||V.push(C);for(const C of F)if(C.id!==k.id&&(F=C.tracks))for(const X of F)F=V.indexOf(X),F!==-1&&V.splice(F,1)}return V},r9Q=async function(k,F){const a=Cp(k.thumbnailDetails);
for(const V of F)if(V.id!==k.id)for(const M of Cp(V.thumbnailDetails))F=a.indexOf(M),F!==-1&&a.splice(F,1);return a},JA=async function(k,F){var a=g.eG("music_downloads_library_id","musicDownloadsLibraryEntity");
let V=await vf(k,a,"musicDownloadsLibraryEntity");V||(V={id:a});a=g.Zk(F).entityType;a==="musicTrack"?V.downloadedTracks?.includes(F)||(V.downloadedTracks=(V.downloadedTracks??[]).concat(F)):a==="musicPlaylist"?V.downloadedPlaylists?.includes(F)||(V.downloadedPlaylists=(V.downloadedPlaylists??[]).concat(F)):a!=="musicAlbumRelease"||V.downloadedAlbumReleases?.includes(F)||(V.downloadedAlbumReleases=(V.downloadedAlbumReleases??[]).concat(F));await Ob(k,V,"musicDownloadsLibraryEntity")},QE=async function(k,
F){var a=g.eG("music_downloads_library_id","musicDownloadsLibraryEntity");
if(a=await vf(k,a,"musicDownloadsLibraryEntity")){var V=g.Zk(F).entityType;let M;V==="musicTrack"?M=a.downloadedTracks:V==="musicPlaylist"&&(M=a.downloadedPlaylists);if(M?.length)for(V=0;V<M.length;V++)if(M[V]===F){M.splice(V,1);break}await Ob(k,a,"musicDownloadsLibraryEntity")}},YPz=async function(k,F,a){var V=g.ky(),M=a.refreshData,C=a.isEnqueuedForExpiredStreamUrlRefetch,X=a.jL,U=a.offlineSourceData;
a=a.mediaCapabilities;k={entityKey:k};M&&(k.refreshData=M);C&&(k.isExpiredStreamUrlRefetch=C);X&&(k.downloadParameters=X);U&&(k.offlineSourceData=U);F={context:g.ig(F),signatureTimestamp:20481,videos:[k]};a&&(F.mediaCapabilities=a);M=g.Vt(BAI);try{var y=await g.Lo(V,F,M,void 0,{Ui:!0})}catch(n){if(n instanceof g.$T)throw y=`GetPDE network manager error: ${n.message}`,Dr(y,n),Error(y);Dr("GetPDE fetch request error",n);throw Error("GetPDE fetch request error");}V=y.errorMetadata?.status;if(y)V!==void 0&&
rB(V,"PDE");else throw Dr("Network request failed for PDE"),Error("Network request failed for PDE");return y},OKz=function(k){var F=k.videos;
k=[];const a=[];if(F)for(const M of F){var V=M.offlineVideoData.videoId;F=g.eG(V,"musicTrack");V=g.eG(V,"musicTrackDownloadMetadataEntity");k.push(F);a.push(V)}return{wJ:k,eL:a}},hA=function(k,F,a){F={track:A9Q(F)};
a&&(F.playlistId=a);if(k=g.p(k.actionMetadata,lLX))F.maximumDownloadQuality=k.maximumDownloadQuality;return{musicTrackEntityActionMetadata:F}},c9z=async function(k){var F=g.ky();
k=i2X(k);const a=g.Vt(v0C);try{var V=await g.Lo(F,k,a,void 0,{Ui:!0})}catch(M){if(M instanceof g.$T)throw V=`GetOffline network manager error: ${M.message}`,Dr(V,M),Error(V);Dr("GetOffline fetch request error",M);throw Error("GetOffline fetch request error");}F=V.errorMetadata?.status;if(!V)throw Dr("Network request failed"),Error("Network request failed");if(F!==void 0)rB(F);else if(!V.videos||!V.videos.length)throw Dr("No data"),Error("No data");return V.videos.map(M=>M.offlineVideoData)},xW=async function(k){var F=
g.ky();
k=f7R(k);const a=g.Vt(v0C);try{var V=await g.Lo(F,k,a,void 0,{Ui:!0})}catch(M){if(M instanceof g.$T)throw V=`GetOffline network manager error for playlist: ${M.message}`,Dr(V,M),Error(V);Dr("GetOffline fetch request error for playlist",M);throw Error("GetOffline fetch request error for playlist");}F=V.errorMetadata?.status;if(!V)throw Dr("Network request failed for playlist"),Error("Network request failed for playlist");if(F!==void 0)rB(F,"playlist");else if(!V.playlists||!V.playlists.length)throw Dr("No data for playlist"),
Error("No data for playlist");return V.playlists.map(M=>M.offlinePlaylistData)},tbZ=async function(k,F,a,V){const M=await tN();
if(!M)return[];var C=[];V?.length?C=V:C=await cf(M,"mainPlaylistEntity");if(!C.length)return[];V=[];const X=Date.now()/1E3;for(const u of C){var U=u.downloadState?await vf(M,u.downloadState,"mainPlaylistDownloadStateEntity"):void 0,y=(C=u?.entityMetadata)&&C.nextAutoRefreshIntervalSeconds?Number(C.nextAutoRefreshIntervalSeconds):NaN;y=Number.isNaN(y)?k:y;var n=U?.lastSyncedTimestampMillis?Number(U?.lastSyncedTimestampMillis)/1E3:0;U=U?.addedTimestampMillis?Number(U?.addedTimestampMillis)/1E3:0;if(a||
!C||n+y<=X){y=[];if(u.videos?.length)for(const K of u.videos)n=JSON.parse(g.Zk(K).entityId),n.videoId&&y.push(n.videoId);n="0";C&&(n=String(Number(C.offlineLastModifiedTimestampSeconds??0).toFixed()));V.push({playlistId:u.playlistId,videoIds:y,offlineLastModifiedTimestamp:n,autoSync:F,offlineDateAddedTimestamp:String(U.toFixed())})}}return V.length?await pkX(V):[]},LiI=async function(){var k=await tN();
if(!k)return!1;k=await cf(k,"refresh");if(!k[0]?.refreshTime)return!1;k=Number(k[0].refreshTime);const F=Date.now()/1E3;return isFinite(k)&&F>=k},joS=async function(k,F){let a;
try{const V=await RiI(k,F);await eiz(V);a=HKS(V)}catch(V){Dr("getAndProcessSmartDownloadsResponse request or processing error",V)}return a},WiZ=async function(k,F,a,V){const M=await tN();
if(!M)return[];var C=[];V?.length?C=V:C=await cf(M,"musicPlaylist");if(!C.length)return[];V=[];const X=Date.now()/1E3;for(const n of C){var U=(C=n?.entityMetadata)&&C.nextAutoRefreshIntervalSeconds?Number(C.nextAutoRefreshIntervalSeconds):NaN;const u=Number.isNaN(U)?k:U;let K=U=0;var y="DOWNLOAD_SYNC_STATE_UNKNOWN";n.downloadMetadata&&(y=await vf(M,n.downloadMetadata,"musicPlaylistDownloadMetadataEntity"),U=Number(y?.addedTimestampMillis??"0")/1E3,K=Number(y?.lastModifiedTimestampMillis??"0")/1E3,
y=y?.syncState??"DOWNLOAD_SYNC_STATE_UNKNOWN");if(a||y!=="DOWNLOAD_SYNC_STATE_UP_TO_DATE"||!C||Number(C.lastSyncedTimestampSeconds??0)+u<=X){C=[];if(n.tracks?.length)for(const q of n.tracks)C.push(g.Zk(q).entityId);V.push({playlistId:n.playlistId,videoIds:C,offlineLastModifiedTimestamp:String(K.toFixed()),autoSync:F,offlineDateAddedTimestamp:String(U.toFixed())})}}return V.length?await pkX(V):[]},RiI=async function(k,F){var a=g.ky(),V=await tN();
let M;V&&(M=await Fi7(V));V=M;k={context:g.Fq(),browseId:"FEdownloads",browseRequestSupportedMetadata:{downloadsBrowseParams:{offlineFeatureSettingState:{isSdEnabled:k},offlineClientState:V,clientStateRequestData:{preferredFormatType:F}}}};F=g.Vt($n8);try{var C=await g.Lo(a,k,F,void 0,{Ui:!0})}catch(X){if(X instanceof g.$T)throw C=`DPS network manager error for smart downloads: ${X.message}`,Dr(C,X),Error(C);Dr("DPS fetch request error for smart downloads",X);throw Error("DPS fetch request error for smart downloads");
}a=C.errorMetadata?.status;if(C)a!==void 0&&rB(a,"smart downloads");else throw Dr("Network request failed for smart downloads"),Error("Network request failed for smart downloads");return C},NAB=async function(k,F){var a=g.ky();
k={context:g.Fq(),videoPlaybackPositionEntities:k,lastSyncTimestampUsec:F};F=g.Vt(E0X);try{var V=await g.Lo(a,k,F,void 0,{Ui:!0})}catch(M){if(M instanceof g.$T)throw V=`VPPS network manager error: ${M.message}`,Dr(V,M),Error(V);Dr("VPPS fetch request error",M);throw Error("VPPS fetch request error");}a=V.errorMetadata?.status;if(V)a!==void 0&&rB(a,"position sync");else throw Dr("Network request failed for position sync"),Error("Network request failed for position sync");return V},rB=function(k,F){F=
F?` for ${F}`:"";
if(k===0)throw k=`Empty response body${F}`,Dr(k),Error(k);k=`Response with error${F}`;Dr(k);throw Error(k);},pkX=async function(k){var F=g.ky();
k=znz(k);const a=g.Vt(Dnz);try{var V=await g.Lo(F,k,a,void 0,{Ui:!0})}catch(M){if(M instanceof g.$T)throw V=`offlinePlaylistSyncCheck network manager error: ${M.message}`,Dr(V,M),Error(V);Dr("offlinePlaylistSyncCheck fetch request error",M);throw Error("offlinePlaylistSyncCheck fetch request error");}F=V.errorMetadata?.status;if(!V)throw Dr("Network request failed for playlist sync"),Error("Network request failed for playlist sync");if(F!==void 0)rB(F,"playlist sync");else if(!V.offlinePlaylistSyncCheckDatas||
!V.offlinePlaylistSyncCheckDatas.length)throw Dr("No data for playlist sync"),Error("No data for playlist sync");return V.offlinePlaylistSyncCheckDatas.map(M=>M.offlinePlaylistSyncCheckData)},iKI=async function(k,F){const a=new Map;
for(const V of F)a.set(V,await k.K(V));return a},AA=function(k,F,a,V,M,C){F=g.eG(F,a);
return{actionType:k,entityKey:F,actionMetadata:{...C,priority:V,retryScheduleIntervalsInSeconds:M}}},GHz=async function(k,F){var a=F.entityKey;
const V=g.p(F.actionMetadata,BK)?.isEnqueuedForExpiredStreamUrlRefetch;try{let C=void 0;C=await fLz(k,F);let X;try{{const U=g.p(F.actionMetadata,BK);var M=U?{maximumDownloadQuality:U.maximumDownloadQuality}:void 0}X=await YPz(a,k.B,{isEnqueuedForExpiredStreamUrlRefetch:V,jL:M,offlineSourceData:C})}catch(U){const y=bO(F)?"OFFLINE_ORCHESTRATION_FAILURE_REASON_RECOVERABLE_NETWORK_ERROR":"OFFLINE_ORCHESTRATION_FAILURE_REASON_UNRECOVERABLE_NETWORK_ERROR";Dr("PDE handleAdd error");return YW(F,!1,void 0,
"OFFLINE_OPERATION_FAILURE_REASON_NETWORK_REQUEST_FAILED",y,"DOWNLOAD_STATE_FAILED")}await zim(k,X,F);return YW(F,!0,X.orchestrationActions)}catch(C){return k="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",a="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",C instanceof g.Q1&&C.type==="QUOTA_EXCEEDED"&&(k="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",a="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"),Dr("PDE handleAdd error"),YW(F,!1,void 0,k,a,"DOWNLOAD_STATE_FAILED")}},
kok=async function(k,F){const a=F.entityKey,V=g.Zk(a).entityId;
var M=await YN(k.D,{mode:"readonly",PB:!0},K=>{const q=Hf(K,a,"playbackData"),T=Hf(K,g.eG(V,"offlineVideoPolicy"),"offlineVideoPolicy");K=Hf(K,g.eG(V,"transfer"),"transfer");return g.Bj.all([q,T,K])});
const [C,X,U]=M;if(!C||!X)return YW(F,!0);M=[];var y=C?.playerResponseJson?JSON.parse(C.playerResponseJson):null;if(U&&y){var n=bKZ(k,y,U);M=await wkz(k,U)}M={lastPlayerResponseTimestampSeconds:C.playerResponseTimestamp,offlineToken:X.offlineToken,formatIds:M};y={};U?.maximumDownloadQuality&&(y.maximumDownloadQuality=U.maximumDownloadQuality);try{let K=void 0;K=await fLz(k,F);try{var u=await YPz(a,k.B,{refreshData:M,jL:y,offlineSourceData:K,mediaCapabilities:n})}catch(q){const T=bO(F)?"OFFLINE_ORCHESTRATION_FAILURE_REASON_RECOVERABLE_NETWORK_ERROR":
"OFFLINE_ORCHESTRATION_FAILURE_REASON_UNRECOVERABLE_NETWORK_ERROR";Dr("PDE handleRefresh error");return YW(F,!1,void 0,"OFFLINE_OPERATION_FAILURE_REASON_NETWORK_REQUEST_FAILED",T,"DOWNLOAD_STATE_FAILED")}await zim(k,u,F);return YW(F,!0,u.orchestrationActions)}catch(K){return k="PDE handleRefresh error",K instanceof Error&&(k=`PDE handleRefresh error: ${K.message}`),n="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",u="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",K instanceof g.Q1&&K.type===
"QUOTA_EXCEEDED"&&(n="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",u="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"),Dr(k),YW(F,!1,void 0,n,u,"DOWNLOAD_STATE_FAILED")}},fLz=async function(k,F){F=g.Zk(F.entityKey).entityId;
F=g.eG(F,"videoDownloadContextEntity");k=await vf(k.D,F,"videoDownloadContextEntity");return k?.offlineModeType?{offlineModeType:k.offlineModeType}:void 0},YW=function(k,F,a,V,M,C){return new Oa(F?"OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS":"OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",bO(k),a,V,M,C)},zim=async function(k,F,a){if(F.frameworkUpdates&&g.p(F.frameworkUpdates,Ig)){if(g.p(F.frameworkUpdates,Ig).mutations&&g.p(F.frameworkUpdates,Ig).mutations.length>0&&g.p(F.frameworkUpdates,Ig).mutations[0].type===
"ENTITY_MUTATION_TYPE_DELETE"){const V=g.Zk(g.p(F.frameworkUpdates,Ig).mutations[0].entityKey).entityId,M=await eq(k.D,V),C=g.p(a.actionMetadata,BK)?.playlistId;
C&&(M.playlistId=C);M.offlineDeleteReason="OFFLINE_DELETE_REASON_UNKNOWN";g.nE(k.B)?await qT(V,k.D,a,k.O,M):g.R4(k.B)&&await dB(V,k.D,a,k.O)}await Lf(g.p(F.frameworkUpdates,Ig))}},bKZ=function(k,F,a){F=XC(k.B,a.cotn,F);
a=g.ZD(F);return g.OU9(F,a,k.B)},wkz=async function(k,F){const a=[];
if(k=await YN(k.D,{mode:"readonly",PB:!0},V=>{const M=[],C=F.offlineVideoStreams;if(C)for(const X of C)M.push(Hf(V,X,"offlineVideoStreams"));return g.Bj.all(M)}))for(const V of k)if(V?.streamsProgress){k=V.streamsProgress;
for(let M=0;M<k.length;M++){const C=JSON.parse(k[M].formatStreamBytes);a.push({itag:C.itag,lmt:C.lastModified,xtags:C.xtags})}}return a},Fj7=async function(k,F){F=bO(F);
k=await cf(k.D,"videoPlaybackPositionEntity");if(k.length===0)return new Oa("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",F);try{const a=await lW.getInstance();if(!a)throw Error("prefStorage is undefined");const V=(await a.get("psi"))?.zA??"0",M=await NAB(k,V),C={isPaused:M.watchHistoryPaused,zA:M.syncTimestampUsec};await a.set("psi",C);if(!C.isPaused){const X=g.p(M.frameworkUpdates,Ig);M.frameworkUpdates&&X&&await Lf(X)}}catch(a){return Dr("PPE handleRefresh error: "+(a instanceof Error?a.message:
"unknown error")),new Oa("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",F,void 0,"OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED","OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED")}return new Oa("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",F)},V5X=async function(k,F){const a=bO(F),V=g.Zk(F.entityKey).entityId;
try{const M=await lW.getInstance();if(!M)throw Error("prefStorage is undefined");const C=await M.get("psi"),X=g.p(F.actionMetadata,aUz);if(C?.isPaused===!1&&X?.lastPlaybackPositionSeconds){const U={key:g.eG(V,"videoPlaybackPositionEntity"),videoId:V,lastPlaybackPositionSeconds:X.lastPlaybackPositionSeconds};await Ob(k.D,U,"videoPlaybackPositionEntity")}}catch(M){return new Oa("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",a,void 0,"OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED","OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED")}return new Oa("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",
a)},M5L=async function(k,F){const a=bO(F);
try{const V=g.Zk(F.entityKey).entityId;if(V==="!*$_ALL_ENTITIES_!*$")await l7k(k.D);else{const M=g.eG(V,"videoPlaybackPositionEntity");await lO(k.D,M)}}catch(V){return new Oa("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",a,void 0,"OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN","OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED")}return new Oa("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",a)},vK=async function(k){return DOL(k)},Cd7=async function(k){return(await g.grH(k)).filter(F=>!!F.url).map(F=>
F.url)},cK=function(k,F){var a=g.$n(F);
if(a===1||a===0)return Promise.resolve();(a=k.player?.getVideoData().videoId===F?k.player:null)&&a.stopVideo();k.O=0;return vK(F)},pp=function(k,F,a=!1,V=!0){F=typeof F==="string"?F:F.videoDetails.videoId;
if(g.$n(F)===2){var M=k.player?.getVideoData().videoId===F?k.player:null;M&&M.stopVideo();g.ER(F,2);k.O=2;a?sIz(k.D):V&&XyI(k.D)}},ysR=async function(k,F){const a=bO(F);
if(await vf(k.D,F.entityKey,"transfer"))return new Oa("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",a);try{await UcS(k,F)}catch(V){return new Oa("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",a,void 0,"OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED","OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED")}return new Oa("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",a)},oAz=async function(k,F){const a=bO(F),V=await vf(k.D,F.entityKey,"transfer");
if(!V||V.transferState!=="TRANSFER_STATE_COMPLETE")return new Oa("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",a);try{await UcS(k,F,!0)}catch(M){return new Oa("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",a,void 0,"OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED","OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED")}return new Oa("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",a)},nAR=async function(k,F){const a=bO(F),V=g.Zk(F.entityKey).entityId,M=await YN(k.D,{mode:"readonly",
PB:!0},U=>{const y=Hf(U,F.entityKey,"transfer");U=Hf(U,g.eG(V,"videoDownloadContextEntity"),"videoDownloadContextEntity");return g.Bj.all([y,U])}),[C,
X]=M;if(!C||C.transferState!=="TRANSFER_STATE_WAITING_FOR_PLAYER_RESPONSE_REFRESH")return new Oa("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",a);try{C.transferState="TRANSFER_STATE_TRANSFER_IN_QUEUE";await Ob(k.D,C,"transfer");const U=g.Zk(C.key).entityId;G9({transferStatusType:"TRANSFER_STATUS_TYPE_REENQUEUED_BY_PLAYER_RESPONSE_REFRESH"},{videoId:U,sM:C,offlineModeType:X?.offlineModeType})}catch(U){return new Oa("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",a,void 0,"OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",
"OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED")}return new Oa("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",a)},UcS=async function(k,F,a=!1){const V=g.p(F.actionMetadata,uem),M=g.Zk(F.entityKey).entityId,C=g.eG(M,"downloadStatusEntity");
var X=await YN(k.D,{mode:"readonly",PB:!0},u=>{const K=Hf(u,C,"downloadStatusEntity");u=Hf(u,g.eG(M,"videoDownloadContextEntity"),"videoDownloadContextEntity");return g.Bj.all([K,u])});
const [U,y]=X;X="TRANSFER_STATE_TRANSFER_IN_QUEUE";U?.downloadState==="DOWNLOAD_STATE_USER_DELETED"&&(X="TRANSFER_STATE_PAUSED_BY_USER");const n={key:F.entityKey,transferState:X,cotn:g.yv(16),enqueuedTimestampMs:Date.now().toString(),maximumDownloadQuality:V?.maximumDownloadQuality,preferredAudioTrack:V?.preferredAudioTrack,transferRetryCount:0,isRefresh:a,hasLoggedFirstStarted:!1};await YN(k.D,{mode:"readwrite",PB:!0},u=>{const K=[];a&&K.push(AN(u,g.eG(M,"offlineVideoStreams")));K.push(hN(u,n,"transfer"));
return g.Bj.all(K)});
a&&await vK(M);G9({transferStatusType:"TRANSFER_STATUS_TYPE_ENQUEUED",statusType:"ADDED_TO_QUEUE"},{videoId:M,sM:n,offlineModeType:y?.offlineModeType})},q5C=function(k,F,a,V){if(!k.action.entityKey)throw Error("entityKey is missing.");
const {Dq:M,entityId:C}=g.Zk(k.action.entityKey),X={entityType:M,entityId:C,offlineOrchestrationActionType:k.action.actionType,orchestrationAction:{orchestrationActionId:k.actionId}};F&&(X.offlineOrchestrationActionResult=F.status,X.isRetryable=a?!1:F.D,F.O&&(X.offlineOrchestrationFailureReason=KjL(F.O,X.isRetryable)));k.action.actionMetadata?.offlineLoggingData?.offlineModeType&&(X.offlineModeType=k.action.actionMetadata.offlineLoggingData.offlineModeType);V&&(X.additionalOrchestrationActions=V.map(U=>
({orchestrationActionId:U.actionId})));
return X},KjL=function(k,F){return k!=="OFFLINE_ORCHESTRATION_FAILURE_REASON_RECOVERABLE_NETWORK_ERROR"||F?k==="OFFLINE_ORCHESTRATION_FAILURE_REASON_UNRECOVERABLE_NETWORK_ERROR"&&F?"OFFLINE_ORCHESTRATION_FAILURE_REASON_RECOVERABLE_NETWORK_ERROR":k:"OFFLINE_ORCHESTRATION_FAILURE_REASON_UNRECOVERABLE_NETWORK_ERROR"},tA=function(k,F){const a={offlineOrchestrationContext:q5C(k)};
F=wrQ(F,a);kHk(b2S(),F,k.rootActionId)},Lp=function(k,F,a,V=[]){F={offlineOrchestrationContext:q5C(k,F,a,V)};
F=wrQ(3,F);kHk(b2S(),F,k.rootActionId)},gAL=function(k,F){for(const a of F)tA(a,1),k.actions.push(a);
k.actions.sort(k.D)},TcS=function(k,F){if(F)for(let a=0;a<k.actions.length;a++)if(F==="!*$_ALL_ENTITIES_!*$"&&k.actions[a].actionId!==F||F!=="!*$_ALL_ENTITIES_!*$"&&k.actions[a].rootActionId===F&&k.actions[a].actionId!==F)k.actions.splice(a,1),a--},IUm=function(k,F){for(const a of k.actions)if(a.actionId===F)return!0;
return!1},eLX=async function(k,F,a,V,M){k=new mck(k,F,a,V,M);
await S5B(k);Z5m(k);return k},S5B=async function(k){const F=await cf(k.K,"offlineOrchestrationActionWrapperEntity");
await Rg(k,F)},Z5m=function(k){const F=k.D.actions[0];
return k.V?(F?.action.actionType==="OFFLINE_ORCHESTRATION_ACTION_TYPE_DELETE"&&k.V[0].action.actionType!=="OFFLINE_ORCHESTRATION_ACTION_TYPE_DELETE"&&(k.Z=!0),Promise.resolve()):dcz(k)},dcz=async function(k){if(k.V)throw Error("Already processing an action");
if(!k.wU()){var F=k.D.actions.shift();y9z(k.I5,!F);if(F!==void 0){F.action.actionType==="OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH"&&F.actionId==="DOWNLOADS_LIST_ENTITY_ID_SMART_DOWNLOADS"&&TcS(k.D,F.actionId);var a="";F.action.actionType==="OFFLINE_ORCHESTRATION_ACTION_TYPE_DELETE"&&F.rootActionId===F.actionId&&(a=F.actionId);var V=[F];k.V=V;if(F=k.D3[F.entityType]){for(const M of V)tA(M,2);try{const M=await iKI(F,V.map(C=>C.action));
for(const C of V){const X=M.get(C.action);await PdZ(k,C,X)}TcS(k.D,a)}catch(M){Dr("Orchestration error",M);try{await H5R(k,V)}catch(C){Dr("Orchestration retry error",C);for(const X of V)X.retryScheduleIndex<3&&gAL(k.D,[X])}}finally{k.V=void 0}}else k.V=void 0;await dcz(k)}}},PdZ=async function(k,F,a){var V=F.retryScheduleIndex+2===3;
if(a.status==="OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS"){var M=void 0;try{M=a.V?.map(C=>k.createAction(C,F))}catch(C){Lp(F,a,V);
iO(k.T,{entityKey:F.action.entityKey,failureReason:"OFFLINE_OPERATION_FAILURE_REASON_UNSUPPORTED_ENTITY_FAILED"});Dr("Orchestration subactions creation error",C);return}Lp(F,a,V,M);if(M){const C=M.map(U=>np(U));
let X=0;for(;X<M.length&&!k.Z;)await YN(k.K,{mode:"readwrite",PB:!0},U=>{const y=[];y.push(xN(U,C.slice(X,X+10),"offlineOrchestrationActionWrapperEntity"));return g.Bj.all(y)}),X+=10;
if(k.Z){k.Z=!1;return}}a=np(F);await lO(k.K,a.key);tA(F,4)}else if(a.status==="OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE")if(Lp(F,a,V),a.D&&F.retryScheduleIndex+1<3)await H5R(k,[F]);else{V={entityKey:F.action.entityKey,failureReason:a?.K?a.K:"OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN"};M=void 0;g.nE(k.B)?M="mainVideoDownloadStateEntity":g.R4(k.B)&&(M="musicTrackDownloadMetadataEntity");if(M&&a.downloadState){const C=g.Zk(F.action.entityKey).entityId;await ag(C,M,k.K,a.downloadState)}iO(k.T,V);a.downloadState===
"DOWNLOAD_STATE_FAILED"&&k.B.A("html5_auto_retry_failed_pde_actions")||(Dr("Orchestration result is not retryable, deleting action"),await lO(k.K,np(F).key))}},H5R=async function(k,F){for(const a of F){const V=a.action?.actionMetadata?.retryScheduleIntervalsInSeconds||[1,
2,4];let M=1;a.retryScheduleIndex<V.length&&(M=V[a.retryScheduleIndex]);a.D=M*1E3+Date.now();a.retryScheduleIndex++}await Js7(k,F)},QIQ=async function(k,F){return(await cf(k.K,"offlineOrchestrationActionWrapperEntity",F)).filter(RnS)},Rg=async function(k,F){let a=[];
var V=Infinity;let M=4E3;for(const X of F){F=Number(X.enqueueTimeSec);const U=rsm(F);var C=X.retryScheduleIndex;C=C!=null&&C>0;U>0&&C?(V=Math.min(V,F),M=Math.min(U,M)):a.push(X)}isFinite(V)&&(!k.O.isActive()||V<k.W)&&(k.W=V,k.O.start(M));k.C.h1()||(V=a.length,a=a.filter(X=>!hLZ.includes(X.actionProto?.actionType||"OFFLINE_ORCHESTRATION_ACTION_TYPE_UNKNOWN")),V=a.length<V,!k.O.isActive()&&V&&k.O.start(1));
a.length>0&&xc8(k,a);await Z5m(k)},rsm=function(k){k=k*1E3-Date.now();
return k>4E3?4E3:k},xc8=function(k,F){F.length!==0&&F.forEach(a=>{a=og(a);
a.retryScheduleIndex<3&&gAL(k.D,[a])})},AsI=async function(k){var F=await QIQ(k);
const a=[];for(const V of F)F=g.Zk(V.key).entityId,IUm(k.D,F)||a.push(V);await Rg(k,a)},Js7=function(k,F){if(F.length===0)return Promise.resolve([]);
F=F.map(a=>np(a));
return O2z(k.K,F)},BcC=async function(k,F){const a=F.videoId;
let V=!0;if(F.captionTracks.length){const M=gVX(F);k.D=new g.dN(k.sO,F,M)}else if(F.gB)k.D=new g.PA(k.sO,F.gB,a,g.BL1(F),F.eJ,F.eventId),V=F.eJ;else return;return new Promise(M=>{k.D?.Z({E8:async()=>{await k.E8(a,V);M()},
rH:()=>{}})})},Y5Z=async function(k){k=await N0Q(k);
return!!k&&k.length>0},O5z=async function(k,F){if(F.length===0)return[];
const a=F.map(M=>g.eG(M,"transfer")),V=(await cf(k.D,"transfer",a)).filter(RnS).map(M=>g.Zk(M.key).entityId);
k=F.filter(M=>V.indexOf(M)===-1);
if(k.length===0)return[];for(const M of k)await vK(M);return k},csk=async function(k,F,a,V,M,C){let X="STREAM_TYPE_UNKNOWN";
a.video&&a.audio?(X="STREAM_TYPE_AUDIO_AND_VIDEO",Dr("unexpected stream type")):a.video&&!a.audio?X="STREAM_TYPE_VIDEO":!a.video&&a.audio&&(X="STREAM_TYPE_AUDIO");const U=g.eG(F,"offlineVideoStreams"),y={numBytesDownloaded:M.toFixed(),numTotalBytes:C.toFixed(),streamType:X,streamState:"DOWNLOAD_STREAM_STATE_IN_PROGRESS",formatStreamBytes:JSON.stringify(V),itag:X==="STREAM_TYPE_AUDIO_AND_VIDEO"?Number(a.itag):void 0};await YN(k,{mode:"readwrite",PB:!0},n=>{const u=Hf(n,U,"offlineVideoStreams"),K=Hf(n,
g.eG(F,"transfer"),"transfer");return g.Bj.all([u,K]).then(([q,T])=>{if(!T)return AN(n,U).then(()=>{});
var S=lUk(q);q=vA7(q,V,y,U);const J=hN(n,q,"offlineVideoStreams");lUk(q)>S&&(T.lastProgressTimeMs=Date.now().toString());S=[J];T.offlineVideoStreams||(T.offlineVideoStreams=[]);T.offlineVideoStreams.indexOf(U)===-1&&(T.offlineVideoStreams.push(U),S.push(hN(n,T,"transfer")));return g.Bj.all(S)})})},pyz=async function(k,F){F=g.eG(F,"offlineVideoStreams");
if((F=await vf(k,F,"offlineVideoStreams"))&&F.streamsProgress){for(const a of F.streamsProgress)a.streamState="DOWNLOAD_STREAM_STATE_COMPLETE",a.numTotalBytes!==a.numBytesDownloaded&&(a.numBytesDownloaded=a.numTotalBytes);await Ob(k,F,"offlineVideoStreams")}},vA7=function(k,F,a,V){if(k&&k.streamsProgress){V=k;
a:{F=`${F.itag};${F.xtags}`;var M=k.streamsProgress;for(let C=0;C<M.length;C++){const X=JSON.parse(M[C].formatStreamBytes);if(`${X.itag};${X.xtags}`===F){M[C]=a;a=M;break a}}M.push(a);a=M}V.streamsProgress=a}else k={key:V,streamsProgress:[a]};return k},lUk=function(k){if(k?.streamsProgress){let F=0;
k=k.streamsProgress;for(let a=0;a<k.length;a++){const V=k[a];isNaN(Number(V.numBytesDownloaded))?Dr("stream progress bytes number invalid"):F+=Number(V.numBytesDownloaded)}return F}return 0},sIz=async function(k){if(k.D){const F=k.D;
k.V.stop();await jq(k,"TRANSFER_STATE_PAUSED_BY_USER");const a=F?.key?g.Zk(F.key).entityId:"";a&&k.O&&await ag(a,k.O,k.K,"DOWNLOAD_STATE_PAUSED");const V=await WK(k,a);uMZ({videoId:a,sM:F,offlineModeType:V})}else $W(k,"onTransferPausedByUser");Ea(k);NT(k)},XyI=async function(k){if(k.D){k.V.stop();
await jq(k,"TRANSFER_STATE_TRANSFER_IN_QUEUE");var F=k.D;(F=F?.key?g.Zk(F.key).entityId:"")&&k.O&&await ag(F,k.O,k.K,"DOWNLOAD_STATE_PAUSED");Ea(k)}else $W(k,"onTransferPausedByNetwork")},DF=async function(k){if(k.D){k.V.start(108E5);
await jq(k,"TRANSFER_STATE_TRANSFERRING");var F=k.D;(F=F?.key?g.Zk(F.key).entityId:"")&&k.O&&await ag(F,k.O,k.K,"DOWNLOAD_STATE_DOWNLOAD_IN_PROGRESS")}else $W(k,"onTransferStart")},t5L=async function(k,F,a){if(k.D){k.D.transferState!=="TRANSFER_STATE_TRANSFERRING"&&await DF(k);
var V=Date.now();V-k.VX>1E3&&(k.VX=V,await csk(k.K,a.videoId,a.K,a.yj,a.bytesDownloaded,a.D),!k.X||k.X&&V-k.I5>k.TL)&&(k.I5=V,V=await WK(k,F),n0R({videoId:F,sM:k.D,offlineModeType:V},a.bytesDownloaded,a.D));k.V.start(108E5)}else $W(k,`onTransferProgress: ${F}`)},RLz=async function(k){if(k.D){var F=k.D;
k.V.stop();if(F&&k.Z){var a=XC(k.api.S(),F.cotn,k.Z);await LjI(k,a)}await jq(k,"TRANSFER_STATE_COMPLETE","DOWNLOAD_STREAM_STATE_COMPLETE");(a=F?.key?g.Zk(F.key).entityId:"")&&k.O&&await ag(a,k.O,k.K,"DOWNLOAD_STATE_COMPLETE");await pyz(k.K,a);var V=await WK(k,a);G9({transferStatusType:"TRANSFER_STATUS_TYPE_COMPLETED",statusType:"SUCCESS"},{videoId:a,sM:F,offlineModeType:V});Ea(k);NT(k)}else $W(k,"onTransferComplete")},jI7=async function(k){await $OZ();
k=k.OO;var F=g.Wb();F=Object.keys(F);await O5z(k,F)},EAm=async function(k){k=(await cf(k.K,"transfer")).filter(WjZ).sort($cR);
return k.length===0?void 0:k[0]},i5X=async function(k,F){if(!k.W){k.W=!0;
k.D=F;var a=g.Zk(k.D.key).entityId;if(k.D.transferState==="TRANSFER_STATE_TRANSFERRING"){var V=await WK(k,a);G9({transferStatusType:"TRANSFER_STATUS_TYPE_RESUME_PROCESSING",statusType:"OFFLINING_RETRIED"},{videoId:a,sM:k.D,offlineModeType:V})}else k.D.transferState!=="TRANSFER_STATE_TRANSFER_IN_QUEUE"||k.D.transferRetryCount||k.D.hasLoggedFirstStarted||(V=await WK(k,a),k.D.hasLoggedFirstStarted=!0,await Ncz(k),n0R({videoId:a,sM:k.D,offlineModeType:V},void 0,void 0,!0));await DF(k);a=null;try{a=await DcC(k,
F),k.Z=a}catch(M){Dr("error getting player response",M,F.cotn);await k.Yy("TRANSFER_FAILURE_REASON_SERVER_PROPERTY_MISSING");return}V=XC(k.api.S(),F.cotn,a);await LjI(k,V);V.Yq=await Cd7(V.videoId);a=k.T;F=F.maximumDownloadQuality;V.getPlayerResponse();g.ER(V.videoId,2);a.O=2;a.K=!1;a.player?.dispose();a.player=a.api.Xr(V);a.player.cg({localmediachange:a.dL,signatureexpired:a.i5,statechange:a.V},a);a.A("html5_generate_content_po_token")&&a.player.GW();F=a.Zg(F);a.player.yp(g.kR(F,F,!0,"m"),!1);a.player.eI(!1);
k.V.start(108E5)}},Ea=function(k){k.D=void 0;
k.Z=void 0;k.V.stop()},NT=async function(k,F=!1){if(k.D)throw Error("Already downloading a video");
k.I5=0;k.W=!1;const a=await EAm(k);o0S(k.a5,!a);a&&k.C.h1()?(F&&await new Promise(V=>{g.HM(V,1E3)}),await i5X(k,a)):!a&&k.D&&Ea(k)},WK=async function(k,F){return(await vf(k.K,g.eG(F,"videoDownloadContextEntity"),"videoDownloadContextEntity"))?.offlineModeType??void 0},fU8=async function(k){k.Z&&(await cK(k.T,k.Z.videoDetails.videoId),Ea(k))},LjI=async function(k,F){try{(F.captionTracks.length||F.gB)&&!await Y5Z(F.videoId)&&await BcC(k.Ml,F)}catch(a){Dr("Caption downloading error",a,F.cotn)}},Ncz=
async function(k,F){if(k.D){var a=k.D;
await YN(k.K,{mode:"readwrite",PB:!0},V=>{const M=[hN(V,a,"transfer")];F&&M.push(F(V));return g.Bj.all(M)})}},DcC=async function(k,F){F=g.Zk(F.key).entityId;
F=g.eG(F,"playbackData");k=await vf(k.K,F,"playbackData");if(k?.playerResponseJson)return JSON.parse(k.playerResponseJson);throw Error("No PlayerResponse found");},jq=async function(k,F,a,V){if(k.D){k.D.transferState=F;
k.D.failureReason=V;try{await Ncz(k,M=>a?JN(M,"offlineVideoStreams",k.D.offlineVideoStreams).then(C=>{for(const X of C)if(X&&X.streamsProgress)for(const U of X.streamsProgress)U.streamState=a;return xN(M,C.filter(X=>!!X),"offlineVideoStreams")}):g.Bj.resolve(void 0))}catch(M){M instanceof g.Q1&&M.type==="QUOTA_EXCEEDED"&&await k.Yy("TRANSFER_FAILURE_REASON_FILESYSTEM_WRITE")}}else $W(k,`saveTransferState: ${F}`)},$W=function(k,F){k.api.K6("woffle",{mcte:F});
Dr("missing current transfer entity.")},zLZ=function(k){const F=(k.D.transferRetryCount||0)<3;
F&&(k=k.D,k.transferRetryCount=(k.transferRetryCount||0)+1);return F},Goz=async function(k,F="TRANSFER_FAILURE_REASON_UNKNOWN"){k.D||$W(k,`setTransferToFailed: ${F}`);
var a="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN";F==="TRANSFER_FAILURE_REASON_NETWORK"?a="OFFLINE_OPERATION_FAILURE_REASON_NETWORK_REQUEST_FAILED":F==="TRANSFER_FAILURE_REASON_FILESYSTEM_WRITE"&&(a="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED");await jq(k,"TRANSFER_STATE_FAILED","DOWNLOAD_STREAM_STATE_ERROR_STREAMS_MISSING",F);iO(k.j,{entityKey:k.D?.key,failureReason:a});a=k.D?g.Zk(k.D.key).entityId:"";const V=await WK(k,a);k={videoId:a,sM:k.D,offlineModeType:V};a={transferStatusType:"TRANSFER_STATUS_TYPE_TERMINATED_WITH_FAILURE",
statusType:"FAILED"};F&&(a.transferFailureReason=F,a.failureReason=Ki7(F));G9(a,k)},WjZ=function(k){return iW[k.transferState]!==void 0},$cR=function(k,F){const a=iW[k.transferState],V=iW[F.transferState];
return a!==V?a-V:Number(k.enqueuedTimestampMs)-Number(F.enqueuedTimestampMs)},b5z=async function(k){g.zD(k.api,"onOrchestrationBecameLeader");
await k.gi()},Fg8=async function(k){const F=await tN();
if(F){k.K=new wyX(F,k.api,k.O,k.D);var a=k.C(F);k.W=await eLX(F,a,k.O,k.D,k.B);await ksL(k)}else Dr("PES is undefined")},ksL=async function(k){if(k.K){k.K.D||await NT(k.K);
k.B.A("woffle_enable_main_downloads_library")&&await k.QX();k.B.A("html5_offline_playback_position_sync")&&(await k.VX(),await k.s$(864E5));await k.refreshAllStaleEntities(43200,!0);await k.X();k.B.A("html5_retry_downloads_for_expiration")&&await k.MV();k.I5=g.JR(()=>{k.refreshAllStaleEntities(43200,!0);k.X()},9E5);
g.ua(g.qM(),()=>k.LN());
var F=await tN();await so8(F);UnX(k.O)}else Dr("transferManager is undefined")},avZ=async function(){const k=await tN();
if(!k)return[];const F=Date.now()/1E3,a=await cf(k,"offlineVideoPolicy");for(const V of a)V.expirationTimestamp&&Number(V.expirationTimestamp)<F&&(V.action="OFFLINE_VIDEO_POLICY_ACTION_DISABLE",V.offlinePlaybackDisabledReason="OFFLINE_PLAYBACK_DISABLED_REASON_CLIENT_OFFLINE_CONTENT_EXPIRED",await Ob(k,V,"offlineVideoPolicy"));return a.map(V=>V.key)},fp=async function(k,F,a,V,M){var C=await tN();
if(!C)return[];F=F.map(X=>{var U=g.eG(X,a);U={actionType:V,entityKey:U,actionMetadata:{...Ua(),...M}};V!=="OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH"&&(U.actionMetadata.priority=0);X=new yE(a,X,U);return np(X)});
C=O2z(C,F);Xk8(k.O);return C},VcC=async function(k,F,a,V){const M=[];
for(const C of F)if(!C.upToDate&&(!a||C.shouldAutoSyncMetadata)&&C.playlistId){F={};switch(V){case "mainPlaylistEntity":F={mainPlaylistEntityActionMetadata:{nextAutoRefreshIntervalSeconds:C.checkInSeconds,autoSync:a}};break;case "musicPlaylist":F={musicPlaylistEntityActionMetadata:{autoSync:a}}}(F=await fp(k,[C.playlistId],V,"OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH",F))&&M.push(...F)}return M},Mcm=async function(k,F){if(F.length){const a=Ua();
g.YX(a,BK,{isEnqueuedForExpiredStreamUrlRefetch:!0});k.api.K6("qrd",{v:F.length});return fp(k,F,"playbackData","OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD",a)}return[]},s8k=async function(k,F){const a=bO(F);
var V=g.Zk(F.entityKey).entityId;let M=[];try{M=await CkR(k,V),k.B.A("woffle_enable_main_downloads_library")&&M?.length&&await Sq(k.D,[F.entityKey])}catch(X){return F="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",V="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",X instanceof g.Q1&&X.type==="QUOTA_EXCEEDED"?(F="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",V="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"):Dr("Playlist add error"),new Oa("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",
a,void 0,F,V)}const C=[];k.B.A("html5_offline_prevent_redownload_downloaded_video")&&(M=await sa(k.D,"mainVideoEntity",M));if(M?.length)for(const X of M)k=X.offlineVideoData,k?.videoId&&C.push(AA("OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD",k.videoId,"mainVideoEntity",Number(F.actionMetadata?.priority||0)+1,zb,Gb(F,k,V)));return new Oa("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",a,C)},UvB=async function(k,F){const a=bO(F);
var V=F.entityKey,M=g.Zk(V).entityId,C=[],X=!1;M==="!*$_ALL_ENTITIES_!*$"?(X=!0,C=await cf(k.D,"mainPlaylistEntity")):(V=await vf(k.D,V,"mainPlaylistEntity"))&&C.push(V);if(!C?.length)return new Oa("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",a);var U=g.p(F.actionMetadata,Xlm);V=U?.nextAutoRefreshIntervalSeconds;const y=U?.autoSync;let n=[],u=!0;U=!0;let K=!1;if(X||y!==!1){try{n=await tbZ(0,!!y,!0,C)}catch(J){J instanceof Error&&J.message==="No data"?M==="!*$_ALL_ENTITIES_!*$"?await Tb(k.D,F,k.O,
"OFFLINE_DELETE_REASON_UNAVAILABLE"):await gB(M,k.D,F,k.O):J instanceof Error&&J.message==="Empty response body"&&Dr(J.message)}if(!n.length||!X&&n[0].playlistId!==M)return new Oa("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",a)}if(X){F=[];for(var q of n)q.upToDate||y&&!q.shouldAutoSyncMetadata||!q.playlistId||F.push(AA("OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH",q.playlistId,"mainPlaylistEntity",0,zb,{mainPlaylistEntityActionMetadata:{nextAutoRefreshIntervalSeconds:q.checkInSeconds,autoSync:y}}));
return new Oa("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",a,F)}n.length&&(q=n[0],K=!!q.upToDate,y&&(u=q.shouldAutoSyncMetadata??!0,U=q.shouldAutoSyncVideos??!0,q.checkInSeconds&&(V=q.checkInSeconds)));if(K||!u)return new Oa("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",a);q=[];C=C[0];X=C.downloadState?await vf(k.D,C.downloadState,"mainPlaylistDownloadStateEntity"):void 0;X=X?.addedTimestampMillis?String(X.addedTimestampMillis):void 0;try{q=await CkR(k,M,X,V)}catch(J){if(J instanceof Error&&J.message===
"No data for playlist")await gB(M,k.D,F,k.O);else if(J instanceof Error&&J.message==="Empty response body for playlist")Dr(J.message);else return F="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",M="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",J instanceof g.Q1&&J.type==="QUOTA_EXCEEDED"&&(F="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",M="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"),new Oa("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",a,void 0,F,M)}if(!U)return new Oa("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",
a);k=[];V=new Map;if(q?.length)for(var T of q)U=T.offlineVideoData,U?.videoId&&V.set(U.videoId,U);T=new Map;U=[];if(C?.videos?.length)for(var S of C.videos)if(C=JSON.parse(g.Zk(S).entityId).videoId)V.has(C)?(T.set(C,V.get(C)),V.delete(C)):U.push(C);S=Number(F.actionMetadata?.priority||0)+1;for(const [J,x]of V.entries())k.push(AA("OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD",J,"mainVideoEntity",S,zb,Gb(F,x,M)));for(const [J,x]of T.entries())k.push(AA("OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH",J,"mainVideoEntity",
S,zb,Gb(F,x,M)));for(const J of U)k.push(AA("OFFLINE_ORCHESTRATION_ACTION_TYPE_DELETE",J,"mainVideoEntity",0,zb,{offlineLoggingData:{offlineDeleteReason:"OFFLINE_DELETE_REASON_PARENT_LIST_REFRESH"},mainVideoEntityActionMetadata:{playlistId:M}}));return new Oa("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",a,k)},ytX=async function(k,F){const a=bO(F);
try{const V=g.Zk(F.entityKey).entityId;V==="!*$_ALL_ENTITIES_!*$"?await Tb(k.D,F,k.O,F.actionMetadata?.offlineLoggingData?.offlineDeleteReason):(await gB(V,k.D,F,k.O),k.B.A("woffle_enable_main_downloads_library")&&await ZF(k.D,F.entityKey))}catch(V){return new Oa("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",a,void 0,"OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED","OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED")}return new Oa("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",
a)},CkR=async function(k,F,a,V){F=await xW([F]);
const {mainPlaylistEntity:M,Og:C}=await okB(k,F[0],a,V);k=mnX(M,C?.avatar);try{await Kp(k)}catch(X){X instanceof Error&&X.message==="Failed to fetch"&&Dr(X.message)}return F[0].videos},Gb=function(k,F,a){F={offlineVideoData:F,
playlistId:a};if(k=g.p(k.actionMetadata,Xlm))F.maximumDownloadQuality=k.maximumDownloadQuality;return{mainVideoEntityActionMetadata:F}},okB=async function(k,F,a,V){const M=Date.now().toString();
a||(a=M);var C=F.videos;const X=F.playlistId,U=[],y=[];if(C)for(const q of C){C=q.offlineVideoData;if(!C||!C.videoId)throw Dr("Invalid offlineVideoData for playlist"),Error("Invalid offlineVideoData for playlist");C=C.videoId;C={id:g.eG(JSON.stringify({videoId:C,playlistId:X}),"mainPlaylistVideoEntity"),video:g.eG(C,"mainVideoEntity")};U.push(C);y.push(C.id)}let n;const u={key:g.eG(X,"mainPlaylistDownloadStateEntity"),addedTimestampMillis:a,lastSyncedTimestampMillis:M},K={key:g.eG(X,"mainPlaylistEntity"),
playlistId:X,videos:y,title:F.title,thumbnailStyleData:nkk(F),visibility:uJk(F),downloadState:u.key};F.channel&&(a=F.channel.offlineChannelData,n=KgR(g.eG(X,"ytMainChannelEntity"),a),K.channelOwner=n.id);K?.entityMetadata?(K.entityMetadata.offlineLastModifiedTimestampSeconds=F.lastModifiedTimestamp,V&&(K.entityMetadata.nextAutoRefreshIntervalSeconds=String(V))):K&&(K.entityMetadata={nextAutoRefreshIntervalSeconds:V?String(V):void 0,offlineLastModifiedTimestampSeconds:F.lastModifiedTimestamp});try{await YN(k.D,
{mode:"readwrite",PB:!0},q=>{var T=hN(q,K,"mainPlaylistEntity");const S=hN(q,u,"mainPlaylistDownloadStateEntity");T=[T,S];for(const J of U)T.push(hN(q,J,"mainPlaylistVideoEntity"));n&&T.push(hN(q,n,"ytMainChannelEntity"));return g.Bj.all(T)})}catch(q){throw Dr("PES failure for playlist"),Error("PES failure for playlist");
}return{mainPlaylistEntity:K,Og:n,wEc:U}},nkk=function(k){const F=[];
var a=k.videos;a&&a.length>0&&F.push({key:Number("PLAYLIST_THUMBNAIL_STYLE_FIRST_VIDEO"),value:{collageThumbnail:{coverThumbnail:a[0].offlineVideoData.thumbnail}}});if((k=k.additionalMetadadatas)&&k.length>0)for(const V of k)switch(k=V.offlineBundleItemPlaylistData,a={collageThumbnail:{coverThumbnail:k?.coverThumbnail}},k?.style){case "BUNDLE_ITEM_STYLE_UNSPECIFIED":F.push({key:Number("PLAYLIST_THUMBNAIL_STYLE_UNKNOWN"),value:a});break;case "BUNDLE_ITEM_STYLE_TWO_BY_TWO":F.push({key:Number("PLAYLIST_THUMBNAIL_STYLE_TWO_BY_TWO"),
value:a});break;case "BUNDLE_ITEM_STYLE_ONE_AND_TWO_AVATAR":F.push({key:Number("PLAYLIST_THUMBNAIL_STYLE_ONE_AND_TWO_AVATAR"),value:a});break;case "BUNDLE_ITEM_STYLE_ONE_AND_TWO":F.push({key:Number("PLAYLIST_THUMBNAIL_STYLE_ONE_AND_TWO"),value:a})}return F},uJk=function(k){switch(k.privacy){case "PRIVATE":return"PLAYLIST_VISIBILITY_PRIVATE";
case "PUBLIC":return"PLAYLIST_VISIBILITY_PUBLIC";case "UNLISTED":return"PLAYLIST_VISIBILITY_UNLISTED";default:return"PLAYLIST_VISIBILITY_UNKNOWN"}},KgR=function(k,F){return{id:k,
channelId:F.channelId,title:F.title,avatar:F.thumbnail}},TDC=async function(k,F){const a=bO(F);
var V=g.Zk(F.entityKey).entityId;const M=g.p(F.actionMetadata,bW),C=!M?.playlistId;try{await qeL(k,V,void 0,M?.offlineVideoData,C)}catch(X){return V="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",F="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",X instanceof g.Q1&&X.type==="QUOTA_EXCEEDED"&&(V="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",F="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"),new Oa("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",a,void 0,V,F)}k=Number(F.actionMetadata?.priority||
0)+1;F=(F=g.p(F.actionMetadata,bW))?{playbackDataActionMetadata:{maximumDownloadQuality:F.maximumDownloadQuality}}:void 0;V=AA("OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD",V,"playbackData",k,gkz,F);return new Oa("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",a,[V])},IvX=async function(k,F){const a=bO(F),V=g.Zk(F.entityKey).entityId;
var M=await vf(k.D,F.entityKey,"mainVideoEntity"),C=M?await vf(k.D,M.downloadState,"mainVideoDownloadStateEntity"):void 0;if(!M||!C)return new Oa("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",a);let X;try{await qeL(k,V,C.addedTimestampMillis,g.p(F.actionMetadata,bW)?.offlineVideoData),M=1,M=Number(F.actionMetadata?.priority||0)+1,X=AA("OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH",V,"playbackData",M,gkz)}catch(U){if(U instanceof Error&&U.message==="No data"){M=await eq(k.D,V);if(C=g.p(F.actionMetadata,
bW)?.playlistId)M.playlistId=C;M.offlineDeleteReason="OFFLINE_DELETE_REASON_UNAVAILABLE";await qT(V,k.D,F,k.O,M)}else if(U instanceof Error&&U.message==="Empty response body")Dr(U.message);else return k="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",F="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",U instanceof g.Q1&&U.type==="QUOTA_EXCEEDED"&&(k="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",F="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"),new Oa("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",
a,void 0,k,F)}return new Oa("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",a,X?[X]:void 0)},mv7=async function(k,F){const a=bO(F);
try{const V=g.Zk(F.entityKey).entityId;if(V==="!*$_ALL_ENTITIES_!*$")await Tb(k.D,F,k.O,F.actionMetadata?.offlineLoggingData?.offlineDeleteReason);else{const M=await eq(k.D,V),C=g.p(F.actionMetadata,bW)?.playlistId;C&&(M.playlistId=C);M.offlineDeleteReason=F.actionMetadata?.offlineLoggingData?.offlineDeleteReason;await qT(V,k.D,F,k.O,M);k.B.A("woffle_enable_main_downloads_library")&&await ZF(k.D,F.entityKey)}}catch(V){return new Oa("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",a,void 0,"OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",
"OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED")}return new Oa("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",a)},qeL=async function(k,F,a,V,M){V||(V=(await c9z([F]))[0]);
const {mainVideoEntity:C,channelEntity:X}=await SeC(k,V,a,M);try{const U=Cp(C.thumbnail),y=Cp(X.avatar);await Kp(U.concat(y))}catch(U){U instanceof Error&&U.message==="Failed to fetch"&&Dr(U.message)}},SeC=async function(k,F,a,V){a||(a=Date.now().toString());
const M=F.channel?.offlineChannelData,C={id:g.eG(F.videoId,"ytMainChannelEntity"),channelId:M.channelId,title:M.title,avatar:M.thumbnail},X={key:g.eG(F.videoId,"mainVideoDownloadStateEntity"),playbackData:g.eG(F.videoId,"playbackData"),addedTimestampMillis:a,videoDownloadContextEntity:g.eG(F.videoId,"videoDownloadContextEntity")},U={key:g.eG(F.videoId,"videoPlaybackPositionEntity"),videoId:F.videoId,lastPlaybackPositionSeconds:"0"};let y;k.B.A("html5_offline_playback_position_sync")&&(y={playbackPosition:U.key});
a=g.eG(F.videoId,"mainVideoEntity");const n={key:a,videoId:F.videoId,title:F.title,thumbnail:F.thumbnail,localizedStrings:{viewCount:F.shortViewCountText},userState:y,lengthSeconds:F.lengthSeconds?Number(F.lengthSeconds):void 0,publishedTimestampMillis:F.publishedTimestamp?(Number(F.publishedTimestamp)*1E3).toString():void 0,formattedDescription:F.description,owner:C.id,downloadState:X.key};let u,K;k.B.A("woffle_enable_main_downloads_library")&&V&&(V=await Qoz(k.D,[a]))&&(u=V.mainDownloadsLibraryEntity,
K=V.mainDownloadsListEntity);let q;q={key:g.eG(F.videoId,"downloadStatusEntity"),downloadState:"DOWNLOAD_STATE_PENDING_DOWNLOAD"};g.YX(X,g0X,q);await YN(k.D,{mode:"readwrite",PB:!0},T=>{var S=hN(T,C,"ytMainChannelEntity"),J=hN(T,X,"mainVideoDownloadStateEntity");const x=hN(T,n,"mainVideoEntity");S=[S,J,x];k.B.A("html5_offline_playback_position_sync")&&(J=hN(T,U,"videoPlaybackPositionEntity"),S.push(J));u&&(J=hN(T,u,"mainDownloadsLibraryEntity"),S.push(J));K&&(J=hN(T,K,"mainDownloadsListEntity"),S.push(J));
q&&(T=hN(T,q,"downloadStatusEntity"),S.push(T));return g.Bj.all(S)});
return{mainVideoEntity:n,channelEntity:C}},eKz=async function(k,F){const a=bO(F),V=[];
var M=await lW.getInstance();let C,X;M&&(C=await M.get("sdois"),X=await M?.get("lmqf"));try{if(C===void 0)throw Error("prefStorage or opt-in state is undefined");M=[];C||(M=await J98(k.D),M.reverse());if(M.length)for(const n of M){if(!n)continue;const u=g.Zk(n).entityId,K=await eq(k.D,u);K.offlineDeleteReason="OFFLINE_DELETE_REASON_PARENT_LIST_DELETE";await qT(u,k.D,{entityKey:n,actionType:F.actionType},k.O,K)}const U=await RiI(C,X??"SD");await eiz(U);const y=HKS(U);k.B.A("woffle_enable_main_downloads_library")&&
(C||await ZF(k.D,m9),await Sq(k.D,[m9]));if(y?.length)for(const n of y){const u=n.actionType,K=n.entityKey,q=n.actionMetadata;if(u&&K&&q&&!g.p(q,ZH8)){u==="OFFLINE_ORCHESTRATION_ACTION_TYPE_DELETE"&&(q.offlineLoggingData={offlineDeleteReason:"OFFLINE_DELETE_REASON_PARENT_LIST_DELETE"});const T=g.p(n.actionMetadata,bW);T&&(T.playlistId="DOWNLOADS_LIST_ENTITY_ID_SMART_DOWNLOADS",n.actionMetadata={...n.actionMetadata,mainVideoEntityActionMetadata:T});V.push(n)}}}catch(U){return k="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",
F="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",U instanceof g.Q1&&U.type==="QUOTA_EXCEEDED"&&(k="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",F="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"),new Oa("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",a,void 0,k,F)}return new Oa("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",a,V)},dvL=async function(k,F=43200,a=!0){if(!k.T.h1())return[];
let V=[];try{V=await tbZ(F,a,!1)}catch(M){M instanceof Error&&M.message==="No data"||M instanceof Error&&M.message==="Empty response body"&&Dr(M.message)}return VcC(k,V,a,"mainPlaylistEntity")},Pkm=async function(k,F,a,V=!1){let M=[];
if(!await LiI()&&!V)return[];a=await joS(F,a);if(!a?.length)return[];F={offlineDeleteReason:"OFFLINE_DELETE_REASON_PARENT_LIST_REFRESH"};for(const X of a){a=X.actionType;var C=X.entityKey;V=X.actionMetadata;a&&C&&V&&!g.p(V,ZH8)&&(a==="OFFLINE_ORCHESTRATION_ACTION_TYPE_DELETE"&&(V.offlineLoggingData=F),{entityId:C}=g.Zk(C),a=await fp(k,[C],"mainVideoEntity",a,V),M=M.concat(a))}return M},Jt7=async function(k,F){const a=bO(F);
var V=g.Zk(F.entityKey).entityId;let M=[];try{M=await HH8(k,V),M?.length&&await JA(k.D,F.entityKey)}catch(X){return F="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",V="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",X instanceof g.Q1&&X.type==="QUOTA_EXCEEDED"&&(F="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",V="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"),new Oa("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",a,void 0,F,V)}const C=[];M=await sa(k.D,"musicTrack",M);if(M.length)for(const X of M)k=
X.offlineVideoData,k?.videoId&&C.push(AA("OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD",k.videoId,"musicTrack",Number(F.actionMetadata?.priority||0)+1,wB,hA(F,k,V)));return new Oa("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",a,C)},Q8R=async function(k,F){const a=bO(F);
var V=F.entityKey,M=g.Zk(V).entityId,C=[],X=!1;M==="!*$_ALL_ENTITIES_!*$"?(X=!0,C=await cf(k.D,"musicAlbumRelease")):(V=await vf(k.D,V,"musicAlbumRelease"))&&C.push(V);if(!C?.length)return new Oa("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",a);if(X){F=[];for(var U of C){var y=g.Zk(U.id).entityId;F.push(AA("OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH",y,"musicAlbumRelease",0,wB))}return new Oa("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",a,F)}U=[];C=C[0];X=void 0;C.downloadMetadata&&(X=await vf(k.D,
C.downloadMetadata,"musicAlbumReleaseDownloadMetadataEntity"),X=Number(X?.addedTimestampMillis??"0")/1E3);try{U=await HH8(k,M,X?.toString())}catch(K){if(K instanceof Error&&K.message==="No data")await PK(M,"musicAlbumRelease",k.D,F,k.O);else if(K instanceof Error&&K.message==="Empty response body")Dr(K.message);else return F="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",y="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",K instanceof g.Q1&&K.type==="QUOTA_EXCEEDED"&&(F="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",
y="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"),new Oa("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",a,void 0,F,y)}k=[];M=new Map;if(U?.length)for(var n of U)U=n.offlineVideoData,U?.videoId&&M.set(U.videoId,U);n=new Map;U=[];if(C?.tracks?.length)for(var u of C.tracks)if(C=g.Zk(u).entityId)M.has(C)?(n.set(C,M.get(C)),M.delete(C)):U.push(C);u=Number(F.actionMetadata?.priority||0)+1;for(const [K,q]of M.entries())k.push(AA("OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD",K,"musicTrack",u,wB,hA(F,q)));for(const [K,
q]of n.entries())k.push(AA("OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH",K,"musicTrack",u,wB,hA(F,q)));for(y of U)k.push(AA("OFFLINE_ORCHESTRATION_ACTION_TYPE_DELETE",y,"musicTrack",0,wB));return new Oa("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",a,k)},rtI=async function(k,F){const a=bO(F);
try{const V=g.Zk(F.entityKey).entityId;V==="!*$_ALL_ENTITIES_!*$"?await HK(k.D,F,k.O):(await PK(V,"musicAlbumRelease",k.D,F,k.O),await QE(k.D,F.entityKey))}catch(V){return new Oa("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",a,void 0,"OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED","OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED")}return new Oa("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",a)},HH8=async function(k,F,a){F=await xW([F]);
k=await hKk(k,F[0],a);k=Cp(k.thumbnailDetails);await Kp(k);return F[0].videos},hKk=async function(k,F,a){var V=F.additionalMetadadatas;
let M=void 0;if(V&&V.length>0)for(var C of V)if(C.offlineMusicPlaylistData){M=C.offlineMusicPlaylistData;break}V=F.playlistId;const {wJ:X,eL:U}=OKz(F);a=a?(Number(a)*1E3).toString():Date.now().toString();C=F.lastModifiedTimestamp?(Number(F.lastModifiedTimestamp)*1E3).toString():"0";const y={id:g.eG(V,"musicAlbumReleaseDownloadMetadataEntity"),trackDownloadMetadatas:U,lastModifiedTimestampMillis:C,addedTimestampMillis:a,syncState:"DOWNLOAD_SYNC_STATE_UP_TO_DATE"},n={id:g.eG(V,"musicAlbumRelease"),
title:F.title,audioPlaylistId:V,trackCount:F.totalVideoCount,tracks:X,downloadMetadata:y.id};M&&(n.thumbnailDetails=M.albumHqThumbnail??M.albumArtistThumbnail,n.artistDisplayName=M.albumArtistDisplayName,n.releaseDate=M.albumReleaseDate,n.contentRating={explicitType:M.albumReleaseExplicitType},n.releaseType=M.albumReleaseType);await YN(k.D,{mode:"readwrite",PB:!0},u=>{const K=hN(u,n,"musicAlbumRelease");u=hN(u,y,"musicAlbumReleaseDownloadMetadataEntity");return g.Bj.all([K,u])});
return n},Atz=async function(k,F){const a=bO(F);
var V=g.Zk(F.entityKey).entityId;let M=[];try{M=await xvI(k,V),M?.length&&await JA(k.D,F.entityKey)}catch(X){return F="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",V="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",X instanceof g.Q1&&X.type==="QUOTA_EXCEEDED"&&(F="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",V="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"),new Oa("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",a,void 0,F,V)}const C=[];M=await sa(k.D,"musicTrack",M);if(M.length)for(const X of M)k=
X.offlineVideoData,k?.videoId&&C.push(AA("OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD",k.videoId,"musicTrack",Number(F.actionMetadata?.priority||0)+1,kE,hA(F,k,V)));return new Oa("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",a,C)},BD7=async function(k,F){const a=bO(F);
var V=F.entityKey,M=g.Zk(V).entityId,C=[],X=!1;M==="!*$_ALL_ENTITIES_!*$"?(X=!0,C=await cf(k.D,"musicPlaylist")):(V=await vf(k.D,V,"musicPlaylist"))&&C.push(V);if(!C?.length)return new Oa("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",a);const U=g.p(F.actionMetadata,lLX)?.autoSync;let y=[],n=!0;V=!0;let u=!1;var K=void 0;if(X||U!==!1){try{y=await WiZ(0,!!U,!0,C)}catch(x){x instanceof Error&&x.message==="No data"?M==="!*$_ALL_ENTITIES_!*$"?await HK(k.D,F,k.O):await PK(M,"musicPlaylist",k.D,F,k.O):x instanceof
Error&&x.message==="Empty response body"&&Dr(x.message)}if(!y.length||!X&&y[0].playlistId!==M)return new Oa("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",a)}if(X){F=[];for(var q of y)q.upToDate||U&&!q.shouldAutoSyncMetadata||!q.playlistId||F.push(AA("OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH",q.playlistId,"musicPlaylist",0,kE,{musicPlaylistEntityActionMetadata:{autoSync:U}}));return new Oa("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",a,F)}y.length&&(q=y[0],u=!!q.upToDate,U&&(n=q.shouldAutoSyncMetadata??
!0,V=q.shouldAutoSyncVideos??!0,q.checkInSeconds&&(K=q.checkInSeconds)));if(u||!n)return new Oa("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",a);q=[];C=C[0];X=void 0;C.downloadMetadata&&(X=await vf(k.D,C.downloadMetadata,"musicPlaylistDownloadMetadataEntity"),X=Number(X?.addedTimestampMillis??"0")/1E3);try{q=await xvI(k,M,X?.toString(),K)}catch(x){if(x instanceof Error&&x.message==="No data")await PK(M,"musicPlaylist",k.D,F,k.O);else if(x instanceof Error&&x.message==="Empty response body")Dr(x.message);
else{F="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN";var T="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED";x instanceof g.Q1&&x.type==="QUOTA_EXCEEDED"&&(F="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",T="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE");return new Oa("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",a,void 0,F,T)}}if(!V)return new Oa("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",a);k=[];M=new Map;if(q?.length)for(var S of q)V=S.offlineVideoData,V?.videoId&&
M.set(V.videoId,V);S=new Map;V=[];if(C?.tracks?.length)for(var J of C.tracks)if(K=g.Zk(J).entityId)M.has(K)?(S.set(K,M.get(K)),M.delete(K)):V.push(K);J=Number(F.actionMetadata?.priority||0)+1;for(const [x,O]of M.entries())k.push(AA("OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD",x,"musicTrack",J,kE,hA(F,O)));for(const [x,O]of S.entries())k.push(AA("OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH",x,"musicTrack",J,kE,hA(F,O)));for(T of V)k.push(AA("OFFLINE_ORCHESTRATION_ACTION_TYPE_DELETE",T,"musicTrack",0,kE));
return new Oa("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",a,k)},YeS=async function(k,F){const a=bO(F);
try{const V=g.Zk(F.entityKey).entityId;V==="!*$_ALL_ENTITIES_!*$"?await HK(k.D,F,k.O):(await PK(V,"musicPlaylist",k.D,F,k.O),await QE(k.D,F.entityKey))}catch(V){return new Oa("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",a,void 0,"OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED","OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED")}return new Oa("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",a)},xvI=async function(k,F,a,V){F=await xW([F]);
k=await OHm(k,F[0],a,V);k=Cp(k.thumbnailDetails);await Kp(k);return F[0].videos},OHm=async function(k,F,a,V){const M=F.playlistId,{wJ:C,
eL:X}=OKz(F);a=a?(Number(a)*1E3).toString():Date.now().toString();const U=F.lastModifiedTimestamp?(Number(F.lastModifiedTimestamp)*1E3).toString():"0",y={id:g.eG(M,"musicPlaylistDownloadMetadataEntity"),trackDownloadMetadatas:X,lastModifiedTimestampMillis:U,addedTimestampMillis:a,syncState:"DOWNLOAD_SYNC_STATE_UP_TO_DATE"},n={id:g.eG(M,"musicPlaylist"),title:F.title,playlistId:M,thumbnailDetails:F.thumbnail,visibility:lvm(F),trackCount:F.totalVideoCount,tracks:C,downloadMetadata:y.id};V&&(n?.entityMetadata?
n.entityMetadata.nextAutoRefreshIntervalSeconds=String(V):n&&(n.entityMetadata={nextAutoRefreshIntervalSeconds:String(V)}));await YN(k.D,{mode:"readwrite",PB:!0},u=>{const K=hN(u,n,"musicPlaylist");u=hN(u,y,"musicPlaylistDownloadMetadataEntity");return g.Bj.all([K,u])});
return n},lvm=function(k){switch(k.privacy){case "PRIVATE":return"PLAYLIST_ENTITY_VISIBILITY_PRIVATE";
case "PUBLIC":return"PLAYLIST_ENTITY_VISIBILITY_PUBLIC";case "UNLISTED":return"PLAYLIST_ENTITY_VISIBILITY_UNLISTED";default:return"PLAYLIST_ENTITY_VISIBILITY_UNKNOWN"}},plL=async function(k,F){const a=bO(F);
var V=g.Zk(F.entityKey).entityId;const M=g.p(F.actionMetadata,FD);try{await vkm(k,V,void 0,M?.track,M?.albumRelease),M?.playlistId||await JA(k.D,F.entityKey)}catch(C){return F="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",V="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",C instanceof g.Q1&&C.type==="QUOTA_EXCEEDED"&&(F="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",V="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"),new Oa("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",a,
void 0,F,V)}k=(k=g.p(F.actionMetadata,FD))?{playbackDataActionMetadata:{maximumDownloadQuality:k.maximumDownloadQuality}}:void 0;F=AA("OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD",V,"playbackData",Number(F.actionMetadata?.priority||0)+1,ctZ,k);return new Oa("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",a,[F])},tcS=async function(k,F){const a=bO(F),V=g.Zk(F.entityKey).entityId;
var M=await vf(k.D,F.entityKey,"musicTrack");const C=M?await vf(k.D,M.downloadMetadata,"musicTrackDownloadMetadataEntity"):void 0;if(!M||!C)return new Oa("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",a);let X;M=g.p(F.actionMetadata,FD);try{await vkm(k,V,C.addedTimestampMillis,M?.track,M?.albumRelease),X=AA("OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH",V,"playbackData",Number(F.actionMetadata?.priority||0)+1,ctZ)}catch(U){if(U instanceof Error&&U.message==="No data")await dB(V,k.D,F,k.O);else if(U instanceof
Error&&U.message==="Empty response body")Dr(U.message);else return k="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",F="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",U instanceof g.Q1&&U.type==="QUOTA_EXCEEDED"&&(k="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",F="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"),new Oa("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",a,void 0,k,F)}return new Oa("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",a,X?[X]:void 0)},Lgm=async function(k,
F){const a=bO(F);
try{const V=g.Zk(F.entityKey).entityId;V==="!*$_ALL_ENTITIES_!*$"?await HK(k.D,F,k.O):(await dB(V,k.D,F,k.O),await QE(k.D,F.entityKey))}catch(V){return new Oa("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",a,void 0,"OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED","OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED")}return new Oa("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",a)},vkm=async function(k,F,a,V,M){V||(V=(await c9z([F]))[0],V=A9Q(V));
const {musicTrackEntity:C,Y3:X}=await RKm(k,V,F,M,a);k=Cp(C.thumbnailDetails);F=[];X&&(F=Cp(X.thumbnailDetails));await Kp(k.concat(F))},RKm=async function(k,F,a,V,M){M||(M=Date.now().toString());
const C={id:g.eG(a,"musicTrackDownloadMetadataEntity"),playbackData:g.eG(a,"playbackData"),addedTimestampMillis:M,videoDownloadContextEntity:g.eG(a,"videoDownloadContextEntity")};V&&(F.albumRelease=V.id);await YN(k.D,{mode:"readwrite",PB:!0},X=>{const U=[];var y=hN(X,C,"musicTrackDownloadMetadataEntity");U.push(y);y=hN(X,F,"musicTrack");U.push(y);V&&(X=hN(X,V,"musicAlbumRelease"),U.push(X));return g.Bj.all(U)});
await ag(a,"musicTrackDownloadMetadataEntity",k.D,"DOWNLOAD_STATE_PENDING_DOWNLOAD");return{musicTrackEntity:F,Y3:V}},j8B=async function(k,F=43200,a=!0){if(!k.T.h1())return[];
let V=[];try{V=await WiZ(F,a,!1)}catch(M){}return VcC(k,V,a,"musicPlaylist")},WgB=function(k){let F;
k=g.p(k.getWatchNextResponse()?.currentVideoEndpoint,g.Mm);k?.playlistId&&(F=k.playlistId);return F},$vC=async function(k,F){const a=F.clientPlaybackNonce,V={cpn:a,
offlineSourceVisualElement:g.nl(F.D3||"").getAsJson(),selectedOfflineMode:"OFFLINE_NOW",isPartialPlayback:!1};F.K&&(V.videoFmt=Number(F.K.itag));F.V&&(V.audioFmt=Number(F.V.itag));const M=WgB(F);var C;if(C=M&&F.videoId)F=F.videoId,C=await (M!=="PPSV"?Promise.resolve(!1):k.D.OO(F));C&&(V.selectedOfflineMode="OFFLINE_MODE_TYPE_AUTO_OFFLINE");k.K=a;g.yJ("offlinePlaybackStarted",V)};
g.f3.prototype.Xr=g.aH(42,function(k){return this.app.Xr(k)});
g.pu.prototype.Xr=g.aH(41,function(k){return g.l09(this,9,k)});
var a1=class{constructor(k){this.D=k}},VG=class extends a1{get entityMetadata(){return this.D.entityMetadata}set entityMetadata(k){this.D.entityMetadata=k}},Ekz=class extends a1{K(){const k=[];this.D.video&&k.push(this.D.video);return[...(new Set(k))]}},NDQ=class extends a1{K(){const k=[];this.D.video&&k.push(this.D.video);this.D.playlist&&k.push(this.D.playlist);this.D.videoItem&&k.push(this.D.videoItem);this.D.playlistItem&&k.push(this.D.playlistItem);return[...(new Set(k))]}},DvS=class extends a1{K(){const k=
[];this.D.localImageEntities&&k.push(...this.D.localImageEntities);this.D.videoDownloadContextEntity&&k.push(this.D.videoDownloadContextEntity);return[...(new Set(k))]}},iHS=class extends a1{K(){const k=[];this.D.recommendedVideoMetadata&&k.push(...(new DvS(this.D.recommendedVideoMetadata)).K());return[...(new Set(k))]}},fvS=class extends a1{K(){const k=[];this.D.playbackPosition&&k.push(this.D.playbackPosition);return[...(new Set(k))]}},zK8=class extends a1{K(){const k=[];this.D.creatorEntity&&k.push(this.D.creatorEntity);
return[...(new Set(k))]}},$n8=["browse","music/browse","streaming_browse","unplugged/browse"],Dnz=["offline/playlist_sync_check"],v0C=["offline"],E0X=["offline/offline_video_playback_position_sync"],BAI=["offline/get_playback_data_entity"],lW=class{constructor(k){this.token=k}static async getInstance(){return new Promise(k=>{g.FU().then(F=>{F?(lW.instance||(lW.instance=new lW(F)),k(lW.instance)):k(void 0)})})}async get(k){if(k=await (await IT(this.token)).get("prefs",k)){var F=(0,g.L)();
return k.expirationTimestampMs<=F?void 0:k.value}}async set(k,F,a=31536E3){const V=(0,g.L)();k={key:k,value:F,expirationTimestampMs:V+a*1E3};await (await IT(this.token)).put("prefs",k)}async remove(k){await (await IT(this.token)).delete("prefs",k)}},Sm,GsI={INVALID_ENCODER_VERSION:"Invalid encoder version",KEY_CREATION_FAILED:"Failed to create encoder key",UNKNOWN_DECODE_ERROR:"Failed to decode PES data",UNKNOWN_ENCODE_ERROR:"Failed to encode PES data",WRONG_DATA_TYPE:"Encoder cannot process the data type"},
Zr=class extends g.o5{constructor(k,F={}){super(GsI[k],{name:"PESEncoderError",type:k,...F});this.type=k;this.level="WARNING";Object.setPrototypeOf(this,Zr.prototype)}},bHS=class{},wlz=class extends bHS{constructor(k){super();this.D=k}O(k,F){F=em(F);k=(new TextEncoder).encode(JSON.stringify(k));return this.D.encrypt(k,F)}K(k,F){if(!(k instanceof Uint8Array))throw new Zr("WRONG_DATA_TYPE",{Yj:1});const a=new TextDecoder;F=em(F);k=this.D.decrypt(k,F);return JSON.parse(a.decode(k))}},H2k={accountLinkStatusEntity:class extends VG{K(){return[]}},
booleanEntity:class extends VG{K(){return[]}},buttonEntity:class extends VG{K(){return[]}},captionTrack:class extends VG{K(){return[]}},channelHandle:class extends VG{K(){return[]}},chatLoadingStateEntity:class extends VG{K(){return[]}},chipEntity:class extends VG{K(){return[]}},commerceAcquisitionClientPayloadEntity:class extends VG{K(){return[]}},commerceCartListEntity:class extends VG{K(){return[]}},compositeSourceEntity:class extends VG{K(){return[]}},multiviewStagingEntity:class extends VG{K(){const k=
[];this.D.compositeSourceKeys&&k.push(...this.D.compositeSourceKeys);return[...(new Set(k))]}},contextNoteFeedEntityPayload:class extends VG{K(){return[]}},contextNoteUserRatingEntityPayload:class extends VG{K(){return[]}},continuationTokenEntity:class extends VG{K(){return[]}},downloadQualityPickerEntity:class extends VG{K(){return[]}},downloadsPageRefreshTokenEntity:class extends VG{K(){return[]}},downloadsPageViewConfigurationEntity:class extends VG{K(){return[]}},downloadStatusEntity:class extends VG{K(){return[]}},
dismissState:class extends VG{K(){return[]}},sfvAudioItemCurrentlyPlayingEntity:class extends VG{K(){return[]}},emojiFountainDataEntity:class extends VG{K(){return[]}},emojiCustomizationSetEntity:class extends VG{K(){return[]}},fakeChannel:class extends VG{K(){const k=[];this.D.alternateChannel&&k.push(this.D.alternateChannel);this.D.alternateChannelList&&k.push(...this.D.alternateChannelList);this.D.oneofChannelEntity&&k.push(this.D.oneofChannelEntity);return[...(new Set(k))]}},fakePlaylist:class extends VG{K(){const k=
[];this.D.entryCollection&&k.push(this.D.entryCollection);return[...(new Set(k))]}},fakePlaylistEntryCollection:class extends VG{K(){const k=[];this.D.parentPlaylist&&k.push(this.D.parentPlaylist);if(this.D.entries)for(const F of this.D.entries)k.push(...(new Ekz(F)).K());return[...(new Set(k))]}},fakeVideo:class extends VG{K(){const k=[];this.D.descriptionEntity&&k.push(this.D.descriptionEntity);this.D.creators&&k.push(...this.D.creators);this.D.theBiggestFan&&k.push(this.D.theBiggestFan);return[...(new Set(k))]}},
fakeVideoDescription:class extends VG{K(){return[]}},featuredProductsEntity:class extends VG{K(){return[]}},flowStateEntity:class extends VG{K(){return[]}},iconBadgeEntity:class extends VG{K(){return[]}},interstitialInteractionStateEntity:class extends VG{K(){return[]}},likeButtonAnimationEntity:class extends VG{K(){return[]}},liveChatPollStateEntity:class extends VG{K(){return[]}},dataFreshnessEntity:class extends VG{K(){return[]}},liveViewerLeaderboardChatEntryPointStateEntity:class extends VG{K(){return[]}},
liveViewerLeaderboardPointsEntity:class extends VG{K(){return[]}},liveReactionsDataEntity:class extends VG{K(){return[]}},logoEntity:class extends VG{K(){return[]}},macroMarkerEntity:class extends VG{K(){return[]}},mainDownloadsLibraryEntity:class extends VG{K(){const k=[];this.D.downloadsList&&k.push(this.D.downloadsList);this.D.smartDownloadsList&&k.push(this.D.smartDownloadsList);this.D.recommendedDownloadsList&&k.push(this.D.recommendedDownloadsList);this.D.refresh&&k.push(this.D.refresh);return[...(new Set(k))]}},
mainDownloadsListEntity:class extends VG{K(){const k=[];this.D.refresh&&k.push(this.D.refresh);if(this.D.downloads)for(const F of this.D.downloads)k.push(...(new NDQ(F)).K());return[...(new Set(k))]}},mainPlaylistDownloadStateEntity:class extends VG{K(){const k=[];this.D.localImageEntities&&k.push(...this.D.localImageEntities);return[...(new Set(k))]}},mainPlaylistEntity:class extends VG{K(){const k=[];this.D.channelOwner&&k.push(this.D.channelOwner);this.D.videos&&k.push(...this.D.videos);this.D.collaboratorChannels&&
k.push(...this.D.collaboratorChannels);this.D.downloadState&&k.push(this.D.downloadState);this.D.refresh&&k.push(this.D.refresh);return[...(new Set(k))]}},mainPlaylistVideoEntity:class extends VG{K(){const k=[];this.D.video&&k.push(this.D.video);this.D.channelContributor&&k.push(this.D.channelContributor);return[...(new Set(k))]}},mainVideoDownloadStateEntity:class extends VG{K(){const k=[];this.D.playbackData&&k.push(this.D.playbackData);this.D.localImageEntities&&k.push(...this.D.localImageEntities);
this.D.videoDownloadContextEntity&&k.push(this.D.videoDownloadContextEntity);return[...(new Set(k))]}},mainVideoEntity:class extends VG{K(){const k=[];this.D.owner&&k.push(this.D.owner);this.D.downloadState&&k.push(this.D.downloadState);this.D.userState&&k.push(...(new fvS(this.D.userState)).K());this.D.additionalMetadata&&k.push(...(new iHS(this.D.additionalMetadata)).K());return[...(new Set(k))]}},markersEngagementPanelSyncEntity:class extends VG{K(){return[]}},markersVisibilityOverrideEntity:class extends VG{K(){return[]}},
musicAlbumReleaseDetail:class extends VG{K(){const k=[];this.D.albumRelease&&k.push(this.D.albumRelease);this.D.tracks&&k.push(...this.D.tracks);return[...(new Set(k))]}},musicAlbumReleaseDownloadMetadataEntity:class extends VG{K(){const k=[];this.D.trackDownloadMetadatas&&k.push(...this.D.trackDownloadMetadatas);return[...(new Set(k))]}},musicAlbumRelease:class extends VG{K(){const k=[];this.D.musicLibraryStatusEntity&&k.push(this.D.musicLibraryStatusEntity);this.D.primaryArtists&&k.push(...this.D.primaryArtists);
this.D.details&&k.push(this.D.details);this.D.userDetails&&k.push(this.D.userDetails);this.D.tracks&&k.push(...this.D.tracks);this.D.share&&k.push(this.D.share);this.D.downloadMetadata&&k.push(this.D.downloadMetadata);this.D.refresh&&k.push(this.D.refresh);return[...(new Set(k))]}},musicAlbumReleaseUserDetail:class extends VG{K(){const k=[];this.D.albumRelease&&k.push(this.D.albumRelease);return[...(new Set(k))]}},musicArtistDetail:class extends VG{K(){const k=[];this.D.parentArtist&&k.push(this.D.parentArtist);
return[...(new Set(k))]}},musicArtist:class extends VG{K(){const k=[];this.D.details&&k.push(this.D.details);this.D.userDetails&&k.push(this.D.userDetails);return[...(new Set(k))]}},musicArtistUserDetail:class extends VG{K(){const k=[];this.D.parentArtist&&k.push(this.D.parentArtist);return[...(new Set(k))]}},musicDownloadsLibraryEntity:class extends VG{K(){const k=[];this.D.downloadedTracks&&k.push(...this.D.downloadedTracks);this.D.smartDownloadedTracks&&k.push(...this.D.smartDownloadedTracks);
this.D.downloadedEpisodes&&k.push(...this.D.downloadedEpisodes);this.D.downloadedAlbumReleases&&k.push(...this.D.downloadedAlbumReleases);this.D.smartDownloadedAlbumReleases&&k.push(...this.D.smartDownloadedAlbumReleases);this.D.downloadedPlaylists&&k.push(...this.D.downloadedPlaylists);this.D.smartDownloadedPlaylists&&k.push(...this.D.smartDownloadedPlaylists);this.D.metadataOnlyTracks&&k.push(...this.D.metadataOnlyTracks);return[...(new Set(k))]}},musicLibraryEdit:class extends VG{K(){return[]}},
musicLibraryStatusEntity:class extends VG{K(){return[]}},musicPlaylist:class extends VG{K(){const k=[];this.D.tracks&&k.push(...this.D.tracks);this.D.refresh&&k.push(this.D.refresh);this.D.musicLibraryStatusEntity&&k.push(this.D.musicLibraryStatusEntity);this.D.details&&k.push(this.D.details);this.D.downloadMetadata&&k.push(this.D.downloadMetadata);this.D.sideloadMetadata&&k.push(this.D.sideloadMetadata);this.D.userDetails&&k.push(this.D.userDetails);this.D.entryCollection&&k.push(this.D.entryCollection);
this.D.share&&k.push(this.D.share);this.D.podcastShowAdditionalMetadata&&k.push(...(new zK8(this.D.podcastShowAdditionalMetadata)).K());return[...(new Set(k))]}},musicPlaylistDownloadMetadataEntity:class extends VG{K(){const k=[];this.D.trackDownloadMetadatas&&k.push(...this.D.trackDownloadMetadatas);return[...(new Set(k))]}},musicShare:class extends VG{K(){return[]}},musicTrackDetail:class extends VG{K(){const k=[];this.D.parentTrack&&k.push(this.D.parentTrack);return[...(new Set(k))]}},musicTrackDownloadMetadataEntity:class extends VG{K(){const k=
[];this.D.playbackData&&k.push(this.D.playbackData);this.D.localImageEntities&&k.push(...this.D.localImageEntities);this.D.videoDownloadContextEntity&&k.push(this.D.videoDownloadContextEntity);return[...(new Set(k))]}},musicTrack:class extends VG{K(){const k=[];this.D.musicLibraryStatusEntity&&k.push(this.D.musicLibraryStatusEntity);this.D.artists&&k.push(...this.D.artists);this.D.audioModeVersion&&k.push(this.D.audioModeVersion);this.D.videoModeVersion&&k.push(this.D.videoModeVersion);this.D.userDetails&&
k.push(this.D.userDetails);this.D.details&&k.push(this.D.details);this.D.albumRelease&&k.push(this.D.albumRelease);this.D.share&&k.push(this.D.share);this.D.libraryEdit&&k.push(this.D.libraryEdit);this.D.downloadMetadata&&k.push(this.D.downloadMetadata);this.D.playbackPosition&&k.push(this.D.playbackPosition);this.D.lyrics&&k.push(this.D.lyrics);return[...(new Set(k))]}},musicTrackUserDetail:class extends VG{K(){const k=[];this.D.parentTrack&&k.push(this.D.parentTrack);return[...(new Set(k))]}},offlineOrchestrationActionWrapperEntity:class extends VG{K(){return[]}},
offlineVideoPolicy:class extends VG{K(){return[]}},offlineVideoStreams:class extends VG{K(){return[]}},offlineabilityEntity:class extends VG{K(){return[]}},orchestrationWebSamplingEntity:class extends VG{K(){const k=[];this.D.fakeChildren&&k.push(...this.D.fakeChildren);return[...(new Set(k))]}},pageHeaderEntity:class extends VG{K(){return[]}},pdpStateEntity:class extends VG{K(){return[]}},pinnedProductEntity:class extends VG{K(){return[]}},playbackData:class extends VG{K(){const k=[];this.D.transfer&&
k.push(this.D.transfer);this.D.adsPlaybackData&&k.push(...this.D.adsPlaybackData);this.D.drmLicense&&k.push(this.D.drmLicense);this.D.offlineVideoPolicy&&k.push(this.D.offlineVideoPolicy);this.D.videoDownloadContextEntity&&k.push(this.D.videoDownloadContextEntity);return[...(new Set(k))]}},playerStateEntity:class extends VG{K(){return[]}},quantityIncrementerEntity:class extends VG{K(){return[]}},refresh:class extends VG{K(){return[]}},saveToPlaylistListEntity:class extends VG{K(){return[]}},selectedChipIndexEntityPayload:class extends VG{K(){return[]}},
settingEntity:class extends VG{K(){return[]}},stringEntity:class extends VG{K(){return[]}},suggestedFeedbackChipStateEntity:class extends VG{K(){return[]}},transfer:class extends VG{K(){const k=[];this.D.offlineVideoStreams&&k.push(...this.D.offlineVideoStreams);this.D.captionTrack&&k.push(...this.D.captionTrack);return[...(new Set(k))]}},trendingOfferEntity:class extends VG{K(){return[]}},videoDownloadContextEntity:class extends VG{K(){return[]}},videoOverviewAsyncDataEntity:class extends VG{K(){return[]}},
videoPlaybackPositionEntity:class extends VG{K(){return[]}},votingEntity:class extends VG{K(){return[]}},ytMainChannelEntity:class extends VG{K(){const k=[];this.D.userChannelDetails&&k.push(this.D.userChannelDetails);return[...(new Set(k))]}},youchatPendingResponseEntity:class extends VG{K(){return[]}},ytMainDownloadedVideoEntity:class extends VG{K(){const k=[];this.D.video&&k.push(this.D.video);this.D.playbackData&&k.push(this.D.playbackData);this.D.offlineVideoPolicy&&k.push(this.D.offlineVideoPolicy);
return[...(new Set(k))]}},ytMainVideoEntity:class extends VG{K(){const k=[];this.D.channelOwner&&k.push(this.D.channelOwner);this.D.playbackPosition&&k.push(this.D.playbackPosition);this.D.localImageEntities&&k.push(...this.D.localImageEntities);this.D.downloadStatus&&k.push(this.D.downloadStatus);return[...(new Set(k))]}}},YVQ=class{constructor(k,F){this.D=k;this.K=F;this.O={}}},kBX=class extends bHS{O(k){return k}K(k){if(k instanceof Uint8Array)throw new Zr("WRONG_DATA_TYPE",{Yj:0});return k}},
vVB=class{constructor(){this.D={};this.D[0]=new kBX;if(!g.x9("aes_pes_encoder_killswitch")){var k=this.D;try{const V=g.UC();var F=em(V);var a=new wlz(new g.jH(F),new g.DB(F))}catch(V){throw k=V instanceof Error?new Zr("KEY_CREATION_FAILED",{originalMessage:V.message}):new Zr("KEY_CREATION_FAILED"),g.W(k),k;}k[1]=a}}},cLL=class extends g.GB{constructor(k,F){super();this.token=k;this.D=F;this.observers=[];k=new g.Tm.BroadcastChannel(`${"PERSISTENT_ENTITY_STORE_SYNC"}:${g.UC()}`);k.onmessage=this.K.bind(this);
this.channel=k}observe(k){this.observers.push(k);return()=>{const F=this.observers.indexOf(k);F>=0&&this.observers.splice(F,1)}}K(k){B07(this,k.data)}p6(){this.channel.close()}},pf;var dnQ=new g.w("elementsCommand");var Ig=new g.w("entityBatchUpdate");var g0X=new g.w("downloadStatusEntity");var Xlm=new g.w("mainPlaylistEntityActionMetadata");var bW=new g.w("mainVideoEntityActionMetadata");var lLX=new g.w("musicPlaylistEntityActionMetadata");var FD=new g.w("musicTrackEntityActionMetadata");var Pez=new g.w("offlineOrchestrationActionCommand");var ZH8=new g.w("localImageEntityActionMetadata");var BK=new g.w("playbackDataActionMetadata");var uem=new g.w("transferEntityActionMetadata");var aUz=new g.w("videoPlaybackPositionEntityActionMetadata");var GkL=class{constructor(){this.D=new Map}},RT;g.eG("","downloadsPageViewConfigurationEntity");g.eG("DOWNLOADS_LIST_ENTITY_ID_MANUAL_DOWNLOADS","mainDownloadsListEntity");var m9=g.eG("DOWNLOADS_LIST_ENTITY_ID_SMART_DOWNLOADS","mainDownloadsListEntity");g.eG("DOWNLOADS_LIST_ENTITY_ID_SMART_DOWNLOADS","refresh");g.eG("SMART_DOWNLOADS_ENABLED","settingEntity");new g.aE;new g.aE;var aLQ=class{constructor(){this.locks=navigator.locks}request(k,F={},a){return this.locks.request(k,F,V=>a(V))}};var $N=g.Tm.caches,Wf,Eb,Fc8=class{open(k){return $N.open(jm(k))}has(k){return $N.has(jm(k))}delete(k){return $N.delete(jm(k))}async match(k,F){var a=await this.keys();for(const V of a)if(a=await (await this.open(V)).match(k,F))return a}},CeI=class extends Fc8{async keys(){const k=[],F=g.UC("CacheStorage keys");var a=await $N.keys();for(const V of a){a=V.indexOf(":");const {UJ:M,datasyncId:C}=a===-1?{UJ:V}:{UJ:V.substring(0,a),datasyncId:V.substring(a+1)};C===F&&k.push(M)}return k}};var aoI=class extends g.GB{constructor(k){super();this.api=k;this.Yh={ff4:()=>this.D,
h1w:()=>this.K};
typeof g.Tm.BroadcastChannel!=="undefined"&&(this.D=new g.Tm.BroadcastChannel(`${"PLAYER_OFFLINE_ERROR_SYNC"}:${g.UC()}`),this.D.onmessage=this.O.bind(this),this.K=new g.Tm.BroadcastChannel(`${"PLAYER_OFFLINE_PAUSE_SYNC"}:${g.UC()}`),this.K.onmessage=this.V.bind(this))}O(k){g.zD(this.api,"onOfflineOperationFailure",k.data)}V(k){this.api.publish("offlinetransferpause",k.data)}p6(){this.D?.close();this.K?.close()}};var VlI=class{constructor(k,F,a){this.W=k;this.X=F;this.visibility=a;this.Z=this.T=this.C=this.O=this.D=!1;this.V=new g.La(()=>{this.yB()});
this.Yh={CX:()=>this.K,
yB:()=>{this.yB()},
kmX:()=>this.V};
this.visibility.subscribe("visibilitystatechange",()=>{this.kH()})}kH(){this.D&&ff(this)}yB(){this.K&&this.K.resolve();
this.O=this.D=!1;this.X()}};var hLZ=["OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD","OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH"];var yE=class{constructor(k,F,a,V,M=F,C,X,U,y,n,u){this.entityType=k;this.actionId=F;this.action=a;this.parentActionId=V;this.rootActionId=M;this.childActionIds=C;this.prereqActionId=X;this.postreqActionIds=U;this.hasChildActionFailed=n;this.retryScheduleIndex=0;this.D=u||Date.now();this.retryScheduleIndex=y||0}};var ZKZ="captionTrack downloadStatusEntity ytMainChannelEntity mainPlaylistEntity mainPlaylistDownloadStateEntity mainPlaylistVideoEntity mainVideoEntity mainVideoDownloadStateEntity offlineVideoPolicy offlineVideoStreams playbackData transfer videoDownloadContextEntity videoPlaybackPositionEntity".split(" ");var xn7="downloadStatusEntity musicAlbumRelease musicDownloadsLibraryEntity musicPlaylist musicTrack musicTrackDownloadMetadataEntity offlineVideoPolicy offlineVideoStreams playbackData transfer videoDownloadContextEntity".split(" ");var MR=class{constructor(k){this.D=k}},Oa=class{constructor(k,F,a,V,M,C){this.status=k;this.D=F;this.V=a;this.K=V;this.O=M;this.downloadState=C}};var MlX=class extends MR{constructor(k,F,a){super(k);this.D=k;this.B=F;this.O=a}K(k){return wj(k)?GHz(this,k):kW(k)?kok(this,k):Promise.reject(Error(`Unsupported action type: ${k.actionType}`))}};var CS7=class extends MR{constructor(k,F){super(k);this.D=k;this.B=F}K(k){return kW(k)?Fj7(this,k):qPL(k)?V5X(this,k):FC(k)?M5L(this,k):Promise.reject(Error(`Unsupported action type: ${k.actionType}`))}};var sRI=class{constructor(k,F){this.api=k;this.D=F;this.logger=new g.Q$("woffle");this.K=!1;this.Yh={Zg:this.Zg}}async V(k){if(k.state.D(128)){const F=k.state.u4;k=F?.errorCode;k=k==="net.connect"&&F?.BI===1?"TRANSFER_FAILURE_REASON_NETWORK_LOST":k?.startsWith("net.")?"TRANSFER_FAILURE_REASON_NETWORK":"TRANSFER_FAILURE_REASON_INTERNAL";await this.Yy(this.player.getVideoData().videoId,k)}}async Yy(k,F){this.K||(this.K=!0,F==="TRANSFER_FAILURE_REASON_NETWORK_LOST"?pp(this,k,!1,!0):(await cK(this,k),
g.ER(k,4),await this.D.Yy(F)))}dL(k){k.status===2?(k.status!==this.O&&(DF(this.D),g.ER(k.videoId,2)),k.Wa&&t5L(this.D,k.videoId,k.Wa)):k.status===4?(cK(this,k.videoId),this.Yy(k.videoId,k.OD?"TRANSFER_FAILURE_REASON_FILESYSTEM_WRITE":"TRANSFER_FAILURE_REASON_INTERNAL")):k.status===1&&RLz(this.D);this.O=k.status;g.zD(this.api,"localmediachange",{videoId:k.videoId,status:k.status})}async i5(){if(!this.K){this.K=!0;var k=this.player.getVideoData().videoId;await cK(this,k);await this.D.i5()}}Zg(k){switch(k){case "HD_1080":return"hd1080";
case "HD":return"hd720";case "SD":return"large";case "LD":return"tiny";default:return"hd720"}}A(k){return this.api.S().A(k)}};var Xcz=class extends MR{constructor(k,F){super(k);this.D=k;this.B=F}K(k){return wj(k)?ysR(this,k):kW(k)?oAz(this,k):qPL(k)?nAR(this,k):Promise.reject(Error(`Unsupported action type: ${k.actionType}`))}};var Uh7=class{constructor(){this.actions=[]}D(k,F){let a=k.action.actionMetadata.priority-F.action.actionMetadata.priority;a===0&&(k.D<F.D?a=-1:k.D>F.D&&(a=1));return a}};var mck=class extends g.GB{constructor(k,F,a,V,M){super();this.K=k;this.D3=F;this.I5=a;this.T=V;this.B=M;this.D=new Uh7;this.C=new g.qr;this.O=new g.La(()=>{this.retry()});
this.W=NaN;this.Z=!1;this.Yh={xzU:()=>this.D,
GH:()=>this.C,
mzL:()=>this.O,
retry:()=>this.retry()};
g.Q(this,this.O);this.X=this.K.observe(this.j.bind(this))}p6(){this.X&&this.X();super.p6()}createAction(k,F){const a=g.Zk(k.entityKey).entityType,V=g.yv(16);return new yE(a,V,k,F.actionId,F.rootActionId)}async j(k){if(!this.wU()){var F=k.offlineOrchestrationActionWrapperEntity??new Set;k=[];for(var a of F)({entityId:F}=g.Zk(a)),IUm(this.D,F)||k.push(a);a=await QIQ(this,k);await Rg(this,a)}}async retry(){await AsI(this)}};var yYC=class{constructor(k){this.sO=k;this.D=void 0}async E8(k,F=!0){if(this.D){var a=[],V=g.a0(this.D.D,F),M=[];for(let C=0;C<V.length;C++)F=this.D.C(V[C],"json3"),F=g.$9(F,{withCredentials:!0,format:"RAW"},3,500).then(X=>{X={metadata:g.rO(V[C]),trackData:X.xhr.responseText};M.push(X)}).d8(X=>{Dr("Caption fetch error",X)}),a.push(F);
await T0I(a);try{await EV8(k,M)}catch(C){Dr("Caption DB transaction error",C)}}}};var olm=class extends g.GB{constructor(k){super();this.D=k;this.K=this.D.observe(this.O.bind(this))}p6(){this.K&&this.K();super.p6()}async O(k){var F=k.transfer??new Set;k=[];for(const a of F)({entityId:F}=g.Zk(a)),k.push(F);k.length!==0&&await O5z(this,k)}};var wyX=class extends g.GB{constructor(k,F,a,V){super();this.K=k;this.api=F;this.a5=a;this.j=V;this.C=new g.qr;this.V=new g.La(()=>{this.D&&this.D.transferState==="TRANSFER_STATE_TRANSFERRING"&&this.C.h1()&&((this.D.transferRetryCount||0)<3?pp(this.T,this.Z,!1,!1):cK(this.T,this.Z.videoDetails.videoId),this.Yy("TRANSFER_FAILURE_REASON_TIMEOUT_NO_PROGRESS"))});
this.I5=this.VX=0;this.X=this.W=!1;this.TL=g.o6(this.api.S().experiments,"html5_transfer_processing_logs_interval");this.Jl=new g.Ms(this);this.Yh={sGl:()=>this.V,
OL6:()=>this.j,
GH:()=>this.C};
this.D3=this.K.observe(this.uw.bind(this));this.T=new sRI(F,this);this.Ml=new yYC(F);this.OO=new olm(this.K);this.cA=this.C.listen("publicytnetworkstatus-online",this.LY.bind(this));this.QX=this.C.listen("publicytnetworkstatus-offline",this.PA.bind(this));this.X=this.api.S().A("html5_less_transfer_processing_logs");g.Q(this,this.Jl);this.Jl.N(F,"offlinetransferpause",this.L6);if(g.nE(this.api.S()))this.O="mainVideoDownloadStateEntity";else if(g.R4(this.api.S())||g.KE(this.api.S()))this.O="musicTrackDownloadMetadataEntity"}p6(){this.D3&&
this.D3();this.OO.dispose();this.V.dispose();this.cA&&g.CF(this.C.qk,this.cA);this.QX&&g.CF(this.C.qk,this.QX);super.p6()}async L6(k){const F=g.eG(k,"transfer");if(this.D&&F===this.D.key)pp(this.T,this.Z,!0),this.V.stop();else{const a=await YN(this.K,{mode:"readwrite",PB:!0},V=>Hf(V,F,"transfer").then(M=>{if(M&&M.transferState!=="TRANSFER_STATE_COMPLETE"&&M.transferState!=="TRANSFER_STATE_FAILED")return M.transferState="TRANSFER_STATE_PAUSED_BY_USER",hN(V,M,"transfer").then(()=>M)}));
if(a){k&&this.O&&await ag(k,this.O,this.K,"DOWNLOAD_STATE_PAUSED");const V=await WK(this,k);uMZ({videoId:k,sM:a,offlineModeType:V})}}}PA(){if(this.D&&this.Z){pp(this.T,this.Z,!1);const k=this.D,F=k?.key?g.Zk(k.key).entityId:"";F&&this.O&&(new Promise((a,V)=>{ag(F,this.O,this.K,"DOWNLOAD_STATE_PAUSED").catch(M=>{V(M)})})).catch(a=>{Dr("Download state setting error",a)})}this.V.stop()}LY(){this.D?i5X(this,this.D):NT(this)}async uw(k){if(this.D&&(this.D.transferState!=="TRANSFER_STATE_COMPLETE"&&this.D.transferState!==
"TRANSFER_STATE_FAILED"&&k.transfer&&k.transfer.has(this.D.key)&&((this.D=await vf(this.K,this.D.key,"transfer"))||await fU8(this)),this.D))return;
await NT(this)}async Yy(k,F){if(this.D){var a=this.D;const M=a?.key?g.Zk(a.key).entityId:"";a:switch(k){case "TRANSFER_FAILURE_REASON_FILESYSTEM_WRITE":case "TRANSFER_FAILURE_REASON_EXTERNAL_FILESYSTEM_WRITE":case "TRANSFER_FAILURE_REASON_PLAYABILITY":case "TRANSFER_FAILURE_REASON_TOO_MANY_RETRIES":var V=!1;break a;default:V=!0}V&&zLZ(this)?(await jq(this,"TRANSFER_STATE_TRANSFER_IN_QUEUE"),k=await WK(this,M),G9({transferStatusType:"TRANSFER_STATUS_TYPE_REENQUEUED_BY_RETRY"},{videoId:M,sM:a,offlineModeType:k}),
M&&this.O&&await ag(M,this.O,this.K,"DOWNLOAD_STATE_RETRYABLE_FAILURE")):(await Goz(this,k),M&&this.O&&await ag(M,this.O,this.K,"DOWNLOAD_STATE_FAILED"))}else $W(this,`onTransferFailure: ${k}`);Ea(this);a=NT(this,!0);F&&F(a)}async i5(k){if(this.D)if(zLZ(this)){await jq(this,"TRANSFER_STATE_WAITING_FOR_PLAYER_RESPONSE_REFRESH");this.D||$W(this,"onMaybeTransferStreamsExpiredRetryAttempting");var F=this.D,a=F?.key?g.Zk(F.key).entityId:"",V=await WK(this,a);G9({transferStatusType:"TRANSFER_STATUS_TYPE_DEQUEUED_BY_PLAYER_RESPONSE_EXPIRATION"},
{videoId:a,sM:F,offlineModeType:V});F=Ua();g.YX(F,BK,{isEnqueuedForExpiredStreamUrlRefetch:!0});V=g.eG(a,"playbackData");a=np(new yE("playbackData",a,{actionType:"OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD",entityKey:V,actionMetadata:F}));await Ob(this.K,a,"offlineOrchestrationActionWrapperEntity")}else await Goz(this,"TRANSFER_FAILURE_REASON_STREAM_MISSING"),this.O&&(a=this.D,(a=a?.key?g.Zk(a.key).entityId:"")&&await ag(a,this.O,this.K,"DOWNLOAD_STATE_FAILED"));else $W(this,"onMaybeTransferStreamsExpired");
Ea(this);a=NT(this,!0);k&&k(a)}},iW={TRANSFER_STATE_TRANSFERRING:1,TRANSFER_STATE_TRANSFER_IN_QUEUE:2};var nlC=class{constructor(k,F){this.B=k;this.api=F;this.T=new g.qr;this.Z=new g.aE;this.Yh={CX:()=>this.O.Yh.CX(),
GH:()=>this.T,
EHF:()=>this.O,
cV:()=>this.cV(),
gi:()=>this.gi(),
xT:()=>this.xT(),
LN:()=>this.LN(),
MV:()=>this.MV(),
s$:a=>this.s$(a)};
this.O=new VlI(()=>b5z(this),()=>{this.xT()},this.api.BJ(),this.api.A.bind(this.api));
this.D=new aoI(this.api);Xk8(this.O)}cV(){return this.Z.promise}gi(){if(this.K&&this.W)return this.Z.promise;Fg8(this).then(this.Z.resolve).catch(this.Z.reject);return this.Z.promise}C(k){return{playbackData:new MlX(k,this.B,this.D),transfer:new Xcz(k,this.B),videoPlaybackPositionEntity:new CS7(k,this.B)}}async LN(){this.K&&await jI7(this.K)}async xT(){if(this.K||this.W)await this.cV(),this.I5!==void 0&&(g.r5(this.I5),this.I5=void 0),this.V!==void 0&&(g.r5(this.V),this.V=void 0),this.K?.dispose(),
this.K=void 0,this.W?.dispose(),this.W=void 0,g.zD(this.api,"onOrchestrationLostLeader"),this.Z=new g.aE}isOrchestrationLeader(){return this.O.D}async OO(){return!1}Im(k){var F=this.D;F.api.publish("offlinetransferpause",k);F.K?.postMessage(k)}async LY(k){const F=await tN();if(F){var a=g.eG(k,"transfer");await YN(F,{mode:"readwrite",PB:!0},V=>{const M=Hf(V,a,"transfer"),C=Hf(V,g.eG(k,"videoDownloadContextEntity"),"videoDownloadContextEntity");return g.Bj.all([M,C]).then(([X,U])=>X&&X.transferState===
"TRANSFER_STATE_PAUSED_BY_USER"?(X.transferState="TRANSFER_STATE_TRANSFER_IN_QUEUE",hN(V,X,"transfer").then(()=>{G9({transferStatusType:"TRANSFER_STATUS_TYPE_REENQUEUED_BY_USER_RESUME",statusType:"USER_RESUMED"},{videoId:k,sM:X,offlineModeType:U?.offlineModeType});return g.Bj.resolve(null)})):g.Bj.resolve(null))})}}async D3(k=43200){if(!this.T.h1())return avZ();
var F=await tN();if(!F)return[];const a=Date.now()/1E3;var V=await cf(F,"offlineVideoPolicy");F=[];for(const M of V)Number(M.lastUpdatedTimestampSeconds)+k<=a&&(V=g.Zk(M.key).entityId,F.push(V));return F.length?fp(this,F,this.j,"OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH"):[]}deleteAll(){return fp(this,["!*$_ALL_ENTITIES_!*$"],this.j,"OFFLINE_ORCHESTRATION_ACTION_TYPE_DELETE",{offlineLoggingData:{offlineDeleteReason:"OFFLINE_DELETE_REASON_USER_INITIATED"}})}async refreshAllStaleEntities(k){return await this.D3(k)}setUpPositionSyncInterval(k){this.V!==
void 0&&(g.r5(this.V),this.V=void 0);const F=k??864E5;this.V=g.JR(()=>{this.s$(F)},F)}async s$(k){try{const F=await lW.getInstance();
if(!F)throw Error("prefStorage is undefined");const a=await F.get("psi"),V=a?.zA?Number(a.zA)/1E3:0,M=Date.now();V+k<=M&&await fp(this,["!*$_ALL_ENTITIES_!*$"],"videoPlaybackPositionEntity","OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH")}catch(F){Dr("Offline manager error",F)}}async MV(){var k=await tN();if(!k)return[];var F=await cf(k,"transfer");k=[];for(const a of F)a.transferState==="TRANSFER_STATE_WAITING_FOR_PLAYER_RESPONSE_REFRESH"&&a.key&&(F=g.Zk(a.key).entityId,k.push(F));return Mcm(this,k)}async X(){return[]}async QX(){}async VX(){}};var uVk=class extends MR{constructor(k,F,a){super(k);this.D=k;this.B=F;this.O=a}K(k){return wj(k)?s8k(this,k):kW(k)?UvB(this,k):FC(k)?ytX(this,k):Promise.reject(Error(`Unsupported action type: ${k.actionType}`))}},zb=[10];var KcX=class extends MR{constructor(k,F,a){super(k);this.D=k;this.B=F;this.O=a}K(k){return wj(k)?TDC(this,k):kW(k)?IvX(this,k):FC(k)?mv7(this,k):Promise.reject(Error(`Unsupported action type: ${k.actionType}`))}},gkz=[10];var qDQ=class extends MR{constructor(k,F,a){super(k);this.D=k;this.B=F;this.O=a}K(k){return kW(k)?eKz(this,k):Promise.reject(Error(`Unsupported action type: ${k.actionType}`))}};var glX=class extends nlC{constructor(){super(...arguments);this.j="mainVideoEntity"}C(k){const F=super.C(k);F.mainVideoEntity=new KcX(k,this.B,this.D);F.mainPlaylistEntity=new uVk(k,this.B,this.D);F.mainDownloadsListEntity=new qDQ(k,this.B,this.D);return F}async refreshAllStaleEntities(k,F){let a=[];this.B.A("web_player_offline_playlist_auto_refresh")&&(a=await dvL(this,k,F));var V=await lW.getInstance();const M=await V?.get("sdois");V=await V?.get("lmqf");M&&(a=a.concat(await Pkm(this,M,V??"SD",
k===0)));return a=a.concat(await super.refreshAllStaleEntities(k,F))}async OO(k){var F=await tN();if(!F)return!1;F=await vf(F,m9,"mainDownloadsListEntity");if(F?.downloads?.length){k=g.eG(k,"mainVideoEntity");for(const a of F.downloads)if(a.videoItem===k)return!0}return!1}async X(){var k=await tN();if(!k)return[];var F=await cf(k,"downloadStatusEntity");k=[];for(const a of F)a.downloadState==="DOWNLOAD_STATE_USER_DELETED"&&a.key&&(F=g.Zk(a.key).entityId,k.push(F));return k.length?fp(this,k,"mainVideoEntity",
"OFFLINE_ORCHESTRATION_ACTION_TYPE_DELETE",{offlineLoggingData:{offlineDeleteReason:"OFFLINE_DELETE_REASON_USER_INITIATED"}}):[]}async VX(){const k=await tN();k&&await YN(k,{mode:"readwrite",PB:!0},F=>JN(F,"mainVideoEntity").then(a=>{const V=[];for(const M of a){if(M.userState?.playbackPosition)continue;a=g.Zk(M.key).entityId;a={key:g.eG(a,"videoPlaybackPositionEntity"),videoId:a,lastPlaybackPositionSeconds:"0"};V.push(hN(F,a,"videoPlaybackPositionEntity"));M.userState={playbackPosition:a.key};V.push(hN(F,
M,"mainVideoEntity"))}return g.Bj.all(V)}))}async QX(){const k=await tN();
if(k){var F=g.eG("DOWNLOADS_LIST_ENTITY_ID_MANUAL_DOWNLOADS","mainDownloadsListEntity"),a=await YN(k,{mode:"readonly",PB:!0},K=>g.Bj.all([Hf(K,F,"mainDownloadsListEntity"),Hf(K,m9,"mainDownloadsListEntity"),JN(K,"mainVideoEntity"),JN(K,"mainPlaylistEntity")])),[V,
M,C,X]=a;a=new Set;if(V?.downloads?.length)for(var U of V.downloads){var y=U.videoItem??U.playlistItem;y&&a.add(y)}if(M?.downloads?.length)for(var n of M.downloads)n.videoItem&&a.add(n.videoItem);U=new Set;n=[];for(var u of X){if(u.videos)for(const K of u.videos)(y=JSON.parse(g.Zk(K).entityId).videoId)&&U.add(y);u.key&&!a.has(u.key)&&n.push(u.key)}for(const K of C)K.key&&!a.has(K.key)&&(u=g.Zk(K.key).entityId,U.has(u)||n.push(K.key));n.length&&await Sq(k,n)}}};var TUI=class extends MR{constructor(k,F){super(k);this.D=k;this.O=F}K(k){return wj(k)?Jt7(this,k):kW(k)?Q8R(this,k):FC(k)?rtI(this,k):Promise.reject(Error(`Unsupported action type: ${k.actionType}`))}},wB=[10];var Io8=class extends MR{constructor(k,F){super(k);this.D=k;this.O=F}K(k){return wj(k)?Atz(this,k):kW(k)?BD7(this,k):FC(k)?YeS(this,k):Promise.reject(Error(`Unsupported action type: ${k.actionType}`))}},kE=[10];var mhm=class extends MR{constructor(k,F){super(k);this.D=k;this.O=F}K(k){return wj(k)?plL(this,k):kW(k)?tcS(this,k):FC(k)?Lgm(this,k):Promise.reject(Error(`Unsupported action type: ${k.actionType}`))}},ctZ=[10];var SDQ=class extends nlC{constructor(){super(...arguments);this.j="musicTrack"}C(k){const F=super.C(k);F.musicTrack=new mhm(k,this.D);F.musicPlaylist=new Io8(k,this.D);F.musicAlbumRelease=new TUI(k,this.D);return F}async refreshAllStaleEntities(k,F){let a=await j8B(this,k,F);return a=a.concat(await super.refreshAllStaleEntities(k,F))}};g.dp("offline",class extends g.ZH{constructor(){super(...arguments);this.events=new g.Ms(this);this.B=this.player.S();this.Yh={pOl:()=>this.D,
MM:()=>this.MM(),
qE:k=>this.qE(k)}}create(){g.Q(this,this.events);
if(g.nE(this.B))this.D=new glX(this.B,this.player);else if(g.R4(this.B)||g.KE(this.B))this.D=new SDQ(this.B,this.player);this.events.N(this.player,"onPlaybackStartExternal",()=>{this.MM()});
this.events.N(this.player,"videodatachange",()=>{this.MM()});
this.B.A("html5_offline_playback_position_sync")&&this.events.N(this.player,"presentingplayerstatechange",this.qE)}k9(){return!1}async K9(k,F,a,V){return this.D?fp(this.D,k,F,a,V):Promise.reject()}deleteAll(){return this.D.deleteAll()}D3(k){return this.D.D3(k)}refreshAllStaleEntities(k){return this.D.refreshAllStaleEntities(k)}setUpPositionSyncInterval(k){this.D.setUpPositionSyncInterval(k)}Im(k){this.D.Im(k)}LY(k){return this.D.LY(k)}async MM(){const k=this.player.getVideoData();k.uI()&&WgB(k)&&
this.K!==k.clientPlaybackNonce&&await $vC(this,k)}async qE(k){var F=this.player.getVideoData();const a=F.iI;if(k.Df(2)||k.Df(512))(k=await tN())?(F=F.videoId,await vf(k,g.eG(F,"mainVideoEntity"),"mainVideoEntity")&&await this.K9([F],"videoPlaybackPositionEntity","OFFLINE_ORCHESTRATION_ACTION_TYPE_UPDATE",{videoPlaybackPositionEntityActionMetadata:{lastPlaybackPositionSeconds:Math.floor(a).toString()}})):Dr("PES is undefined")}isOrchestrationLeader(){return this.D.isOrchestrationLeader()}async updateDownloadState(k,
F){const a=await tN();if(a){var {entityType:V,entityId:M}=g.Zk(k);await ag(M,V,a,F,!0)}else Dr("PES is undefined")}});})(_yt_player);
